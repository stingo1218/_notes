## 2.1 物理层的基本概念

物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。

物理层的作用是要尽可能地屏蔽掉不同传输媒体和通信手段的差异。

用于物理层的协议也常称为物理层规程 (procedure)。

- 机械特性 ：指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等。
- 电气特性：指明在接口电缆的各条线上出现的电压的范围。
- 功能特性：指明某条线上出现的某一电平的电压的意义。
- 过程特性 ：指明对于不同功能的各种可能事件的出现顺序。  

**物理层的主要任务**

主要任务：确定与传输媒体的接口的一些特性。

## 2.2 数据通信的基础知识

### 2.2.1 数据通信系统的模型

一个数据通信系统包括三大部分：源系统（或发送端、发送方）、传输系统（或传输网络）和目的系统（或接收端、接收方）。

![image-20220316171023223](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401085026.png)

#### 常用术语

- **数据** (data) —— 运送消息的实体。
- **信号** (signal) —— 数据的电气的或电磁的表现。 
- **模拟信号** (analogous signal) —— 代表消息的参数的取值是连续的。 
- **数字信号** (digital signal) —— 代表消息的参数的取值是离散的。 
- **码元** (code) —— 在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。

### 2.2.2 有关信道的几个基本概念

- **信道** —— 一般用来表示向某一个方向传送信息的媒体。
- **单向通信**（单工通信）——只能有一个方向的通信而没有反方向的交互。
- **双向交替通信**（半双工通信）——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。
- **双向同时通信**（全双工通信）——通信的双方可以同时发送和接收信息。 

#### 调制分为两大类：

- **基带调制**：仅对基带信号的波形进行变换，使它能够与信道特性相适应。变换后的信号仍然是基带信号。把这种过程称为编码 (coding)。
- **带通调制**：使用载波 (carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号，这样就能够更好地在模拟信道中传输（即仅在一段频率范围内能够通过信道） 。

带通信号 ：经过载波调制后的信号。

#### (1) 常用编码方式

- **不归零制**：正电平代表 1，负电平代表 0。
- **归零制**：正脉冲代表 1，负脉冲代表 0。
- **曼彻斯特编码**：位周期中心的向上跳变代表 0，位周期中心的向下跳变代表 1。但也可反过来定义。
- **差分曼彻斯特编码**：在每一位的中心处始终都有跳变。位开始边界有跳变代表 0，而位开始边界没有跳变代表 1。

![image-20220316171241922](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316171242.png/)

从信号波形中可以看出，曼彻斯特 (Manchester) 编码和差分曼彻斯特编码产生的信号频率比不归零制高。

从自同步能力来看，不归零制不能从信号波形本身中提取信号时钟频率（这叫做没有自同步能力），而曼彻斯特编码和差分曼彻斯特编码具有自同步能力。

#### (2) 基本的带通调制方法

基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。为了解决这一问题，就必须对基带信号进行调制 (modulation)。 

最基本的二元制调制方法有以下几种：

**调幅**(AM)：载波的振幅随基带数字信号而变化。 

**调频**(FM)：载波的频率随基带数字信号而变化。

**调相**(PM) ：载波的初始相位随基带数字信号而变化。 

  ![image-20220316171326391](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316171326.png/)

#### 正交振幅调制 QAM (Quadrature Amplitude Modulation) 

为了达到更高的信息传输速率，必须采用技术上更为复杂的多元制的振幅相位混合调制方法。

例如：

可供选择的相位有 12 种，而对于每一种相位有 1 或 2 种振幅可供选择。总共有 16 种组合，即 16 个码元。

由于 4 bit 编码共有 16 种不同的组合，因此这 16 个点中的每个点可对应于一种 4 bit 的编码。数据传输率可提高 4 倍。 

 ![image-20220316171725288](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316171725.png/)

不是码元越多越好。若每一个码元可表示的比特数越多，则在接收端进行解调时要正确识别每一种状态就越困难，出错率增加。 

### 2.2.3 信道的极限容量 

- 任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。 
- 码元传输的速率越高，或信号传输的距离越远，或传输媒体质量越差，在信道的输出端的波形的失真就越严重。 

#### 数字信号通过实际的信道 

![image-20220316171745313](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401085031.png)

### 2.2.3 信道的极限容量 

从概念上讲，限制码元在信道上的传输速率的因素有以下两个：

- 信道能够通过的频率范围
- 信噪比

#### (1) 信道能够通过的频率范围

- 具体的信道所能通过的频率范围总是有限的。信号中的许多高频分量往往不能通过信道。
- 1924 年，奈奎斯特 (Nyquist) 就推导出了著名的奈氏准则。他给出了在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值。

在任何信道中，码元传输的速率是有上限的，否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能。

如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰。

#### (2) 信噪比 

噪声存在于所有的电子设备和通信信道中。

噪声是随机产生的，它的瞬时值有时会很大。因此噪声会使接收端对码元的判决产生错误。

但噪声的影响是相对的。如果信号相对较强，那么噪声的影响就相对较小。

信噪比就是信号的平均功率和噪声的平均功率之比。常记为S/N，并用分贝 (dB) 作为度量单位。即：

`信噪比(dB) = 10 log10(S/N ) (dB)` 

例如，当S/N=10时，信噪比为10dB，而当S/N=1000时，信噪比为30dB。 

1984年，香农 (Shannon) 用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率（香农公式）。

信道的极限信息传输速率 C 可表达为：

​       `C = W log2(1+S/N)  (bit/s)` 

其中：

- W 为信道的带宽（以 Hz 为单位）；
- ​    S 为信道内所传信号的平均功率；
- ​    N 为信道内部的高斯噪声功率。 

<u>**香农公式表明**</u>

信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。 

**只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。**

**若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道不可能是这样的），则信道的极限信息传输速率 C 也就没有上限。**

实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。 

<u>**请注意**</u> 

对于频带宽度已确定的信道，如果信噪比不能再提高了，并且码元传输速率也达到了上限值，那么还有办法提高信息的传输速率。

这就是：<u>**用编码的方法让每一个码元携带更多比特的信息量。**</u> 

## 2.3 物理层下面的传输媒体

传输媒体也称为传输介质或传输媒介，它就是数据传输系统中在发送器和接收器之间的物理通路。

传输媒体可分为两大类，即导引型传输媒体和非导引型传输媒体。

在导引型传输媒体中，电磁波被导引沿着固体媒体（铜线或光纤）传播。

非导引型传输媒体就是指自由空间。在非导引型传输媒体中，电磁波的传输常称为无线传输。

电信领域使用的电磁波的频谱：

![image-20220316172057767](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172057.png/)

 

### 2.3.1 导引型传输媒体

#### 双绞线

最常用的传输媒体。

- 模拟传输和数字传输都可以使用双绞线，其通信距离一般为几到十几公里。
- 屏蔽双绞线 STP (Shielded Twisted Pair)
- 带金属屏蔽层
- 无屏蔽双绞线 UTP (Unshielded Twisted Pair) 

双绞线的示意图 

![image-20220316172407400](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172407.png/)

##### 双绞线标准

1991 年，美国电子工业协会 EIA 和电信行业协会联合发布了一个用于室内传送数据的无屏蔽双绞线和屏蔽双绞线的标准 EIA/TIA-568。

1995 年将布线标准更新为 EIA/TIA-568-A。

此标准规定了 5 个种类的 UTP 标准（从 1 类线到 5 类线）。

对传送数据来说，现在最常用的 UTP 是5类线（Category 5 或 CAT5）。

#### 同轴电缆

- 同轴电缆具有很好的抗干扰特性，被广泛用于传输较高速率的数据。

- 同轴电缆的带宽取决于电缆的质量。
- 50 Ω 同轴电缆 —— LAN / 数字传输常用
- 75 Ω 同轴电缆 —— 有线电视 / 模拟传输常用

同轴电缆的结构

 ![image-20220316172507878](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172507.png/)

#### 光缆

- 光纤是光纤通信的传输媒体。

- 由于可见光的频率非常高，约为 108 MHz 的量级，因此一个光纤通信系统的传输带宽远远大于目前其他各种传输媒体的带宽。

  

**光线在光纤中的折射** 

![image-20220316172527131](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172527.png/)

当光线从高折射率的媒体射向低折射率的媒体时，其折射角将大于入射角。因此，如果入射角足够大，就会出现全反射，光也就沿着光纤传输下去。

**光纤的工作原理**

![image-20220316172733510](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172733.png/)

只要从纤芯中射到纤芯表面的光线的入射角大于某个临界角度，就可产生全反射。



**多模光纤与单模光纤**

- 多模光纤 
  - 可以存在多条不同角度入射的光线在一条光纤中传输。这种光纤就称为多模光纤。
- 单模光纤
  - 若光纤的直径减小到只有一个光的波长，则光纤就像一根波导那样，它可使光线一直向前传播，而不会产生多次反射。这样的光纤称为单模光纤。

![image-20220316172829152](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316172829.png/)

**光纤通信中使用的光波的波段**

- 常用的三个波段的中心分别位于 <u>850 nm, 1300 nm 和 1550 nm。</u>
- 所有这三个波段都具有 <u>25000~30000 GHz 的带宽</u>，可见光纤的通信容量非常大。

**光纤优点**

1. 通信容量非常大。
2. 传输损耗小，中继距离长。
3. 抗雷电和电磁干扰性能好。
4. 无串音干扰，保密性好。
5. 体积小，重量轻。

### 2.3.2 非导引型传输媒体 

- 将自由空间称为“非导引型传输媒体”。
- 无线传输所使用的频段很广。
- 短波通信（即高频通信）主要是靠电离层的反射，但短波信道的通信质量较差，传输速率低。
- 微波在空间主要是直线传播。
- 传统微波通信有两种方式： 
  - 地面微波接力通信
  - 卫星通信 

 

 

####  无线局域网使用的 ISM 频段 

要使用某一段无线电频谱进行通信，通常必须得到本国政府有关无线电频谱管理机构的许可证。但是，也有一些无线电频段是可以自由使用的。例如：ISM。各国的 ISM 标准有可能略有差别。

![image-20220316173047423](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173047.png/)

 

## 2.4信道复用技术

 

 

### 2.4.1 频分复用、时分复用和统计时分复用 

复用的示意图

![image-20220316173110670](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173110.png/)

复用 (multiplexing) 是通信技术中的基本概念。

它允许用户使用一个共享信道进行通信，降低成本，提高利用率。

 

#### 频分复用 FDM (Frequency Division Multiplexing) 

将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。

频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。

![](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173137.png/)

#### 时分复用TDM (Time Division Multiplexing) 

- **时分复用**则是将时间划分为一段段等长的**时分复用帧**（TDM帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
- 每一个用户所占用的时隙是**周期性地出现**（其周期就是TDM帧的长度）的。
- TDM 信号也称为**等时** (isochronous) 信号。
- **时分复用的所有用户在不同的时间占用同样的频带宽度。**

 

 

![image-20220316173410103](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173410.png/) 

时分复用可能会造成线路资源的浪费 

使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。

![image-20220316173739791](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173739.png/) 

 

#### 统计时分复用 STDM (Statistic TDM) 

![image-20220316173812589](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173812.png/)

### 2.4.2  波分复用 WDM(Wavelength Division Multiplexing) 



波分复用就是光的频分复用。使用一根光纤来同时传输多个光载波信号。

![image-20220316173842885](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316173842.png/)

### 2.4.3  码分复用 CDM (Code Division Multiplexing) 

- 常用的名词是码分多址 CDMA (Code Division Multiple Access)。
- 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。
- 这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。 

 

#### 码片序列(chip sequence) 

- 每一个比特时间划分为 m 个短的间隔，称为码片 (chip)。
- 每个站被指派一个唯一的 m bit 码片序列。
  - 如发送比特 1，则发送自己的 m bit 码片序列。
  - 如发送比特 0，则发送该码片序列的二进制反码。 
- 例如，S 站的 8 bit 码片序列是 00011011。
  - 发送比特 1 时，就发送序列 00011011，
  - 发送比特 0 时，就发送序列 11100100。
- S 站的码片序列：(–1 –1 –1 +1 +1 –1 +1 +1) 





#### 码片序列实现了扩频

- 假定S站要发送信息的数据率为 b bit/s。由于每一个比特要转换成 m 个比特的码片，因此 S 站实际上发送的数据率提高到 mb bit/s，同时 S 站所占用的频带宽度也提高到原来数值的 m 倍。

- 这种通信方式是**扩频**(spread spectrum)通信中的一种。

- 扩频通信通常有两大类：
  1. 一种是**直接序列扩频DSSS** (Direct Sequence Spread Spectrum)，如上面讲的使用码片序列就是这一	类。
  2. 另一种是**跳频扩频FHSS** (Frequency Hopping Spread Spectrum)。

 

#### CDMA 的重要特点

- 每个站分配的码片序列不仅**必须各不相同**，并且还**必须互相正交** (orthogonal)。
- 在实用的系统中是使用**伪随机码序列**。 

 

##### 码片序列的正交关系 

- 令向量 S 表示站 S 的码片向量，令 T 表示其他任何站的码片向量。 

- 两个不同站的码片序列正交，就是向量 S 和T 的规格化**内积** (inner product) 等于 0： 

![image-20220316174024460](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316174024.png/)

##### 正交关系的另一个重要特性 

任何一个码片向量和该码片向量自己的规格化内积都是 1 。

![image-20220316174040517](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316174040.png/) 

一个码片向量和该码片反码的向量的规格化内积值是 –1。 

![image-20220316174057336](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316174057.png/) 

### **作业**

> 共有四个站进行码分多址CDMA通信。四个站的码片序列为：
>    A: (-1 -1 -1 +1 +1 -1 +1 +1).    B: (-1 -1 +1 -1 +1 +1 +1 -1).
>    C: (-1 +1 -1 +1 +1 +1 -1 -1).    D: (-1 +1 -1 -1 -1 -1 +1 -1).
>   现收到的码片序列为（-1 +1 -1 -1 -1 -1 -1 +1 -1）.问哪个站发送数据了？发送数据的站发送的1还是0？

这个问题其实就是个解方程的问题。
k1(-1,-1,-1,1,1,-1,1,-1)+k2(-1,-1,1,-1,1,1,1,-1)+k3(-1,1,-1,1,1,1,-1,-1)+k4(-1,1,-1,-1,-1,1,-1)=(-1,1,-3,1,-1,-3,1,1)
这里,,k3,k4可以取值-1,0,1.
可以得到8个方程，然后解出方程组，就知道了。事实上，我们只需要几个方程就可以解出来了。
第一个数字 ---k3-k4=-1
第二个数字 -k1-k2+k3+k4=1
两式相加，得-2k1-2k2=0--->k1=-k2,k3+k4=1.
第三个数字-k1+k2-k3-k4=-3--->-(-k2)+k2-(k3+k4)=-3--->2k2-1=-3--->k2=-1
所以k1=1
第4个数字，k1-k2+k3-k4=1--->1-(-1)+(1-k4)-k4=1, k4=1,因此k3=0.
所以不需要解出所有8个方程，我们已经知道了k1=k4=1,k2=-1,k3=0.
这就说明A,D发送了源码，B发送了反码，C没有发送任何代码

解法二：

这个问题也可以不通过上面的解方程的办法，而直接从这5个码片看出：因为每个码片或者是1，或者是-1，而我们看到最后收到的码片的第三，第六个数字为3，这说明信号一定是通过叠加而成，就是说不止一个站发送了信息。如果是两个或者四个站参与了发送信息，不管是源码或者反码，得到的数字一定是偶数。因此可以推出，有三个站参与了发送。我们先来看4个站码片的第3个和第6个数字，A，B，C，D分别为-1,1,-1,-1和-1,1,1,-1.除了C的数字从-1变为1外，其他三个数字都没有变，而收到的码片相应的数字都是-3，这就说明C站没有参与发送信息，否则收到的码片第3个第6个数字会不同。因此A，B，D参与了发送信息。再看第三个数字，A，B，D的第三个数字分别为-1,1,-1，而收到的叠加的码片的第3个数字为-3，因此只有A，D发送源代码，B发送反代码才能获得。

结论：A，D发送了1，B发送了0，C没有发送数据



## 2.5 数字传输系统

- 在早期电话网中，从市话局到用户电话机的用户线是采用最廉价的双绞线电缆，而长途干线采用的是频分复用 FDM 的模拟传输方式。
- **与模拟通信相比，数字通信无论是在传输质量上还是经济上都有明显的优势。**
- 目前，长途干线大都采用时分复用 PCM 的数字传输方式。
- **脉码调制 PCM** 体制最初是为了在电话局之间的中继线上传送多路的电话。

- 由于历史上的原因，PCM 有两个互不兼容的国际标准：
- 北美的 24 路 PCM（简称为 T1）
- 欧洲的 30 路 PCM（简称为 E1）
- 我国采用的是欧洲的 E1 标准。
- E1 的速率是 2.048 Mbit/s，而 T1 的速率是 1.544 Mbit/s。
- 当需要有更高的数据率时，可采用复用的方法。 

#### 旧的数字传输系统存在许多缺点

最主要的是以下两个方面： 

- **速率标准不统一**
  - 如果不对高次群的数字传输速率进行标准化，国际范围的**基于光纤高速数据传输就很难实现**。 
- **不是同步传输**
  - 在过去相当长的时间，为了节约经费，各国的数字网主要采用准同步方式。 
  - 当数据传输的速率很高时，**收发双方的时钟同步就成为很大的问题**。 

#### 同步光纤网 SONET

- **同步光纤网** SONET (Synchronous Optical Network) 的各级时钟都来自一个非常精确的主时钟。 
- SONET 为光纤传输系统定义了同步传输的线路速率等级结构
  - 对电信信号称为第 1 级**同步传送信号** STS-1 (Synchronous Transport Signal)，其传输速率是 51.84 Mbit/s。
  - 对光信号则称为第 1 级**光载波** OC-1 (OC 表示Optical Carrier)。
- 现已定义了从 51.84 Mbit/s (即OC-1) 一直到 9953.280 Mbit/s (即 OC-192/STS-192) 的标准。 

#### 同步数字系列 SDH 

- ITU-T 以美国标准 SONET 为基础，制订出国际标准同步数字系列 SDH (Synchronous Digital Hierarchy)。
- 一般可认为 SDH 与 SONET 是同义词。
- **其主要不同点是**：SDH的基本速率为155.52 Mbit/s，称为第 1 级**同步传递模块** (Synchronous Transfer Module)，即 STM-1，相当于 SONET 体系中的 OC-3 速率。

#### SONET / SDH 标准的意义

- 使不同的数字传输体制在 STM-1 等级上获得了统一。
- 第一次真正实现了数字传输体制上的世界性标准。
- 已成为公认的新一代理想的传输网体制。
- SDH 标准也适合于微波和卫星传输的技术体制。

## 2.6宽带接入技术

- 用户要连接到互联网，必须先连接到某个ISP。
- 在互联网的发展初期，用户都是利用电话的用户线通过调制解调器连接到ISP的，电话用户线接入到互联网的速率最高仅达到56 kbit/s。
- 美国联邦通信委员会FCC原来认为只要双向速率之和超过200 kbit/s 就是宽带。但 2015 年重新定义为：
  - 宽带下行速率要达到 25 Mbit/s
  - 宽带上行速率要达到 3 Mbit/s

- 从宽带接入的媒体来看，可以划分为两大类：
  - 有线宽带接入
  - 无线宽带接入
- 下面讨论有线的宽带接入。

### 2.6.1 ADSL 技术

- **非对称数字用户线 ADSL** (Asymmetric Digital Subscriber Line) 技术就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务。
- 标准模拟电话信号的频带被限制在 300~3400 Hz 的范围内，但用户线本身实际可通过的信号频率仍然超过 1 MHz。
- ADSL 技术就把 0~4 kHz 低端频谱留给传统电话使用，而把**原来没有被利用的高端频谱留给用户上网使用**。
- DSL 就是**数字用户线** (Digital Subscriber Line) 的缩写。

#### DSL 的几种类型 

- **ADSL** (Asymmetric Digital Subscriber Line)：非对称数字用户线
- **HDSL** (High speed DSL)：高速数字用户线
- **SDSL** (Single-line DSL)：1 对线的数字用户线
- **VDSL** (Very high speed DSL)：甚高速数字用户线
- **DSL** (Digital Subscriber Line) ：数字用户线
- **RADSL** (Rate-Adaptive DSL)：速率自适应 DSL，是 ADSL 的一个子集，可自动调节线路速率）

#### ADSL 的传输距离

- ADSL 的传输距离取决于数据率和用户线的线径（用户线越细，信号传输时的衰减就越大）。
- ADSL 所能得到的最高数据传输速率与实际的用户线上的信噪比密切相关。
- 例如：
  - 0.5 毫米线径的用户线，传输速率为 1.5~2.0 Mbit/s 时可传送5.5公里，但当传输速率提高到 6.1 Mbit/s 时，传输距离就缩短为 3.7 公里。
  - 如果把用户线的线径减小到 0.4 毫米，那么在 6.1 Mbit/s 的传输速率下就只能传送 2.7 公里。

 

#### ADSL 的特点

上行和下行带宽做成不对称的。

上行指从用户到 ISP，而下行指从 ISP 到用户。

ADSL 在用户线（铜线）的两端各安装一个 **ADSL 调制解调器**。

我国目前采用的方案是**离散多音调 DMT** (Discrete Multi-Tone)调制技术。

这里的“多音调”就是“**多载波**”或“**多子信道**”的意思。

 

#### DMT 技术

DMT 调制技术采用**频分复用**的方法，把 40 kHz 以上一直到 1.1 MHz 的高端频谱划分为许多子信道，其中 25 个子信道用于上行信道，而 249 个子信道用于下行信道。

每个子信道占据 4 kHz 带宽（严格讲是 4.3125 kHz），并使用不同的载波（即不同的音调）进行数字调制。这种做法相当于在一对用户线上使用许多小的调制解调器**并行地**传送数据。

![image-20220316174838174](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316174838.png/) 

#### ADSL 的数据率

- 由于用户线的具体条件往往相差很大（距离、线径、受到相邻用户线的干扰程度等都不同），**因此 ADSL 采用自适应调制技术使用户线能够传送尽可能高的数据率。**
- 当 ADSL 启动时，用户线两端的 ADSL 调制解调器就测试可用的频率、各子信道受到的干扰情况，以及在每一个频率上测试信号的传输质量。
- **ADSL 不能保证固定的数据率**。对于质量很差的用户线甚至无法开通 ADSL。
- 通常下行数据率在32 kbit/s到6.4 Mbit/s之间，而上行数据率在 32 kbit/s 到 640 kbit/s 之间。

#### ADSL 的组成

![image-20220316174936239](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316174936.png/)

#### 第二代 ADSL 

- 包括 ADSL2（G.992.3 和 G.992.4）和 ADSL2+（G.992.5）。
- 通过提高调制效率得到了**更高的数据率**。
- ADSL2 要求至少应支持下行 8 Mbit/s、上行 800 kbit/s的速率。
- ADSL2+ 则将频谱范围从 1.1 MHz 扩展至 2.2 MHz，下行速率可达 16 Mbit/s（最大传输速率可达 25 Mbit/s），而上行速率可达 800 kbit/s。
- 采用了**无缝速率自适应技术** SRA (Seamless Rate Adaptation)，可在运营中不中断通信和不产生误码的情况下，自适应地调整数据率。
- 改善了线路质量评测和故障定位功能，这对提高网络的运行维护水平具有非常重要的意义。

### 2.6.2 光纤同轴混合网（HFC网）

- HFC (Hybrid Fiber Coax) 网是在目前覆盖面很广的有线电视网 CATV 的基础上开发的一种居民宽带接入网。
- HFC 网除可传送 CATV 外，还提供电话、数据和其他宽带交互型业务。
- 现有的 CATV 网是树形拓扑结构的同轴电缆网络，它采用模拟技术的频分复用对电视节目进行单向传输。
- **HFC 网对 CATV 网进行了改造。** 

 

#### HFC 网的主干线路采用光纤

- HFC 网将原 CATV 网中的同轴电缆**主干部分改换为光纤**，并使用**模拟光纤技术**。
- 在模拟光纤中采用**光的振幅调制AM**，这比使用数字光纤更为经济。
- 模拟光纤从头端连接到**光纤结点** (fiber node)，即**光分配结点** ODN (Optical Distribution Node)。在光纤结点光信号被转换为电信号。在光纤结点以下就是同轴电缆。 

![image-20220316181534904](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316181534.png/) 

#### HFC 网具有双向传输功能，扩展了传输频带

![image-20220316181626174](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316181626.png/)

#### 每个家庭要安装一个用户接口盒 

- **用户接口盒 UIB** (User Interface Box) 要提供**三种连接**，即：
  - 使用同轴电缆连接到机顶盒 (set-top box)，然后再连接到用户的电视机。
  - 使用双绞线连接到用户的电话机。
  - 使用电缆调制解调器连接到用户的计算机。

 

#### 电缆调制解调器 (Cable Modem) 

- 电缆调制解调器是为 HFC 网而使用的调制解调器。
- 电缆调制解调器最大的特点就是传输速率高。
  - 下行速率一般在 3 ~ 10 Mbit/s之间，最高可达 30 Mbit/s。
  - 上行速率一般为 0.2 ~ 2 Mbit/s，最高可达 10 Mbit/s。
- 电缆调制解调器比在普通电话线上使用的调制解调器要复杂得多，并且不是成对使用，而是只安装在用户端。 

 

### 2.6.3 FTTx 技术 

- FTTx 是一种实现宽带居民接入网的方案，代表多种宽带光纤接入方式。
- FTTx 表示 Fiber To The…（光纤到…），例如：
  - **光纤到户 FTTH** (Fiber To The Home)：光纤一直铺设到用户家庭，可能是居民接入网最后的解决方法。
  - **光纤到大楼 FTTB** (Fiber To The Building)：光纤进入大楼后就转换为电信号，然后用电缆或双绞线分配到各用户。
  - **光纤到路边 FTTC** (Fiber To The Curb)：光纤铺到路边，从路边到各用户可使用星形结构双绞线作为传输媒体。

#### 无源光网络 PON (Passive Optical Network) 的组成 

![image-20220316181748348](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316181748.png/)

# 第 3 章 数 据 链 路 层

**计算机网络体系结构**

![image-20220316182448776](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182448.png/)

**数据链路层是实现设备之间通信的非常重要的一层**

![image-20220316182505870](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182505.png/)

![image-20220316182518353](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182518.png/)

**数据链路层的作用**

![image-20220316182603458](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182603.png/)

![image-20220316182635767](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182635.png/)

**数据链路层使用的信道**

![image-20220316182702444](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182702.png/)

![image-20220316182726425](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182726.png/)

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

- **链路** (link) 是一条无源的点到点的物理线路段，中间**没有**任何其他的交换结点。
  - 一条链路只是一条通路的一个组成部分。
  - **或物理链路**
- **数据链路** (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
  - 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。
  - 一般的适配器都包括了数据链路层和物理层这两层的功能。 
  - **或逻辑链路**
  - 典型实现:适配器(网卡)

 

### 3.1.1 数据链路和帧

- 也有人采用另外的术语。这就是把链路分为物理链路和逻辑链路。
- **物理链路**就是上面所说的链路。
- **逻辑链路**就是上面的数据链路，是物理链路加上必要的通信协议。
- 早期的数据通信协议曾叫做通信规程 (procedure)。因此在数据链路层，规程和协议是同义语。

#### 数据链路层传送的是帧

![image-20220316182904901](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182905.png/)

#### 数据链路层像个数字管道 

- 常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位是帧。
- 数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。

![image-20220316182944563](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316182944.png/)

#### 帧

##### 分组与帧的关系

- **分组**（packet）  有 的地方也称之为包或者数据包 ，许多人认为这个术语正确地表示了运行在OSI参考模型 网络层上 的协议所发送的报文。所以你将经常见到人们提到 IP分组 。然而， 这个术语也通常用来一般性地表示任何类型的报文 ，如前所述。
- **帧**（frame） 这个术语最经常是与在OSI参考模型的底层上传输的报文相联系的。特别是最常见它用于表示数据链路层上的报文。当报文格式由第1层的技术形成时，偶尔也用于表示物理层上的报文。帧这个称谓来源于以下事实，就是它是通过获得较高层的分组或数据报然后附加上较低层需要的首部信息“成帧”而成的。

### 3.1.2 三个基本问题 

数据链路层协议有许多种，但有三个基本问题则是共同的。这三个基本问题是：

- **封装成帧**
- **透明传输**
  - 用户不受协议任何限制
  - 帧的组装与拆解对网络层不可见
- **差错控制** 

####  1. 封装成帧

封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。

- **首部和尾部的一个重要作用就是进行帧定界**。 **使用定界符(帧首部,尾部)来区分**
- **MTU:最大有效负载**

![image-20220316183028387](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183028.png/)

##### 用控制字符进行帧定界的方法举例

当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。

- 控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始。
- 另一个控制字符 EOT (End Of Transmission) 表示帧的结束。

![image-20220525122308509](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220525122308.png) 

###### 定界符法

- 字节计数法
  - 容易破坏帧边界
- 带字节填充的定界符法
  - 定界符:一个特殊的字节,如01111110,用于方法前后两个不同的帧

#### 2.透明传输

如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”。

![image-20220316183158524](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183158.png/)

#####  解决透明传输问题

- 解决方法：**字节填充** (byte stuffing) **或字符填充** (character stuffing)。
- 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)。
- 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
- 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 

##### 透明

指某一个实际存在的事物看起来却好像不存在一样。

> “在数据链路层透明传送数据”表示无论发送什么样的比特组合的数据，这些数据都能够按照原样没有差错地通过这个数据链路层。

##### 用“字节填充”法解决透明传输的问题

![image-20220316183249216](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183249.png/)

#### 3.差错检测

![image-20220316183328894](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183329.png/)

- 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率** BER (Bit Error Rate)。
- 误码率与信噪比有很大的关系。
- 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。 
- 在数据链路层传送的帧中，广泛使用了**循环冗余检验** CRC 的检错技术。

##### 循环冗余检验的原理

![image-20220316183413909](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183414.png/)

- 在发送端，先把数据划分为组。假定每组 k 个比特。 
- 在每组 M 后面再添加供差错检测用的 n 位**冗余码**，然后一起发送出去。 

##### 冗余码的计算

- 用二进制的模 2 运算进行 2^n^ 乘 M 的运算，这相当于在 M 后面添加 n 个 0。
- 得到的 (k + n) 位的数除以**事先**选定好的长度为 (n + 1) 位的除数 P，得出商是 Q 而余数是 R，余数 R 比除数 P 少 1 位，即 R 是 n 位。 
- 将**余数 R** 作为**冗余码**(**所有检验码都可以叫做帧检测序列** *FCS*)拼接在数据 M 后面，一起发送出去。

![image-20220316183455541](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183455.png/)

##### 接收端对收到的每一帧进行 CRC 检验

- (1) 若得出的余数 R = 0，则判定这个帧没有差错，就**接受** (accept)。
- (2) 若余数 R ≠ 0，则判定这个帧有差错，就**丢弃**。
- 但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。
- 只要经过严格的挑选，并使用位数足够多的除数 P，那么出现检测不到的差错的概率就很小很小。 

###### 冗余码的计算举例 

现在 k = 6, M = 101001。

设 n = 3, 除数 P = 1101，

被除数是 2nM = 101001000。 

模 2 运算的结果是：商 Q = 110101，余数 R = 001。

把余数 R 作为冗余码添加在数据 M 的后面发送出去。发送的数据是：2nM + R，即：101001001，共 (k + n) 位。 

![image-20220316183540765](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220321143552.png/)

#### 循环冗余检验的原理说明



##### 帧检验序列 FCS

- **在数据后面添加上的冗余码称为帧检验序列** FCS (Frame Check Sequence)。
- 循环冗余检验 CRC 和帧检验序列 FCS 并不等同。
  - **CRC 是一种常用的<u>检错方法</u>，而 FCS 是添加在数据后面的<u>冗余码</u>。**
  - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法。 

###### 应当注意

- 仅用循环冗余检验 CRC 差错检测技术只能做到**无差错接受** (accept)。
- **“无差错接受”是指**：“<u>凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错</u>”。
- 也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。
- **单纯使用 CRC 差错检测技术不能实现“无差错传输”或“可靠传输”。**

- 应当明确，**“无比特差错”与“无传输差错”是不同的概念。**
- 在数据链路层使用 CRC 检验，能够实现**无比特差错**的传输，但这还不是**可靠传输**]。
- 要做到“无差错传输”（即发送什么就收到什么）就必须再加上确认和重传机制。 
- 本章介绍的数据链路层协议都不是可靠传输的协议。

## 3.2点对点协议 PPP

### 3.2.1 PPP 协议的特点

- 对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。
- PPP 协议在 1994 年就已成为互联网的正式标准。

#### 用户到 ISP 的链路使用 PPP 协议 

![image-20220316183732392](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183732.png/)

##### 1.PPP 协议应满足的需求

1. 简单 —— **这是首要的要求**。
2. 封装成帧 —— 必须规定特殊的字符作为帧定界符。

3. 透明性 —— 必须保证数据传输的透明性。

4. 多种网络层协议 —— 能够在同一条物理链路上同时支持多种网络层协议。

5. 多种类型链路 —— 能够在多种类型的链路上运行。

6. 差错检测 —— 能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
7. 检测连接状态 —— 能够及时自动检测出链路是否处于正常工作状态。
8. 最大传送单元 —— 必须对每一种类型的点对点链路设置最大传送单元 MTU 的标准默认值，促进各种实现之间的互操作性。
9. 网络层地址协商 —— 必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。
10. 数据压缩协商 —— 必须提供一种方法来协商使用数据压缩算法。

##### 2. PPP 协议不需要的功能

- 纠错 
- 流量控制 
- 序号 
- 多点线路 
- 半双工或单工链路 

#####  3. PPP 协议的组成

PPP 协议有三个组成部分：

1. 一个将 IP 数据报**封装**到串行链路的方法。
2. **链路控制协议 LCP** (Link Control Protocol)。
3. **网络控制协议 NCP** (Network Control Protocol)。 

### 3.2.2  PPP 协议的帧格式

- PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。
- **标志字段** F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。
- **地址字段** A 只置为 0xFF。地址字段实际上并不起作用。
- **控制字段** C 通常置为 0x03。
- **PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。**

 ![image-20220316183936728](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316183936.png/)

#### 透明传输问题 

- 当 PPP 用在异步传输时，就使用一种特殊的**字符填充法**。
- 当 PPP 用在同步传输链路时，协议规定采用硬件来完成**比特填充**（和 HDLC 的做法一样）。  

#####  字符填充

-  将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)。 
-  若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)。
-  若信息字段中出现 ASCII 码的控制字符（**即数值小于 0x20 的字符**），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。**转义** 

![image-20220316184100172](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184100.png/)

#####  零比特填充

-  PPP 协议用在 SONET/SDH 链路时，使用同步传输（一连串的比特连续传送）。**这时 PPP 协议采用零比特填充方法来实现透明传输。**
-  在发送端，只要发现有 5 个连续 1，则立即填入一个 0。
-  接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。

![image-20220316184145270](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184145.png/)

####  不提供使用序号和确认的可靠传输 

-  PPP 协议之所以**不使用**序号和确认机制是出于以下的考虑：
   - 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
   - 在因特网环境下，PPP 的信息字段放入的数据是 IP  数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
   - 帧检验序列 FCS 字段可保证无差错接受。



###  3.2.3  PPP 协议的工作状态

- 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
- PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
- 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
- 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。
- **可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。**

![image-20220316184313430](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184313.png/)

## 3.3使用广播信道的数据链路层

### 3.3.1 局域网的数据链路层 

局域网最主要的**特点**是：

- 网络为一个单位所拥有；
- 地理范围和站点数目均有限。 

局域网具有如下**主要优点**：

- 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
- 提高了系统的可靠性、可用性和残存性。

#### 局域网拓扑结构

![image-20220316184548897](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184549.png/) 

#### 局域网传输媒体

 ![image-20220316184602050](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184602.png/)

#### 共享信道带来的问题

![image-20220316184616109](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184616.png/)

#### 媒体共享技术

**静态划分信道**

1. 频分复用
2. 时分复用
3. 波分复用
4. 码分复用 

**动态媒体接入控制（多点接入）**

- 随机接入
- 受控接入 ，如多点线路探询 (polling)，或轮询。    

##### 1. 以太网的两个标准 

- **DIX Ethernet V2** 是世界上第一个局域网产品（以太网）的规约。
- **IEEE 802.3** 是第一个 IEEE 的以太网标准。

*DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。*

- 严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网 。 
- 为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成两个子层：
  - **逻辑链路控制** LLC (Logical Link Control)子层；
  - **媒体接入控制** MAC (Medium Access Control)子层。
- 与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。
- **不管采用何种协议的局域网，对 LLC 子层来说都是透明的。**

####  局域网对 LLC 子层是透明的

![image-20220316184753038](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184753.png/)

一般不考虑 LLC 子层

- 由于 TCP/IP 体系经常使用的局域网是 DIX Ethernet V2 而不是 802.3 标准中的几种局域网，因此现在 802 委员会制定的逻辑链路控制子层 LLC（即 802.2 标准）的作用已经不大了。
- 很多厂商生产的适配器上就仅装有 MAC 协议而没有 LLC 协议。 

#### 计算机通过适配器和局域网进行通信

 ![image-20220316184945952](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316184946.png/)

###### 适配器的作用

- 网络接口板又称为**通信适配器** (adapter) 或**网络接口卡** NIC (Network Interface Card)，或“**网卡**”。 
- 适配器的重要功能：
  1. **进行串行/并行转换。**
  2. **对数据进行缓存。**
  3. **在计算机的操作系统安装设备驱动程序。**
  4. **实现以太网协议。**

### 3.3.2  CSMA/CD 协议

最初的以太网是将许多计算机都连接到一根总线上。**易于实现广播通信**。当初认为这样的连接方法既简单又可靠，因为总线上没有有源器件。 

 ![image-20220316185003254](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185003.png/)

为了实现**一对一**通信，将接收站的硬件地址写入帧首部中的**目的地址**字段中。仅当数据帧中的目的地址与适配器的硬件地址一致时，才能接收这个数据帧。

 ![image-20220316185033741](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185033.png/)

总线也有**缺点**。若多台计算机或多个站点同时发送时，会产生发送碰撞或冲突，导致发送失败。

 ![image-20220316185108912](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185109.png/)

#### 以太网采取了两种重要的措施

为了通信的简便，以太网采取了两种重要的措施：

##### (1) 采用较为灵活的**无连接的工作方式**

- 适合少量突发性数据

- 不必先建立连接就可以直接发送数据。
- 对发送的数据帧不进行编号，也不要求对方发回确认。



- **提供不可靠的交付服务**
  - **这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的。**
  - **以太网提供的服务是不可靠的交付，即尽最大努力的交付。**
  - 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。**差错的纠正由高层来决定。**
  - 如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。 
- **同一时间只允许一台计算机发送**
  - 以太网采用最简单的随机接入
  - 使用CSMA/CD协议减少冲突发生的概率

如何避免同时发送产生的碰撞？ 采用 CSMA/CD

**冲突时同时等待随机长的时间再发送,这样冲突概率就大大减小**

![image-20220316185213818](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185213.png/)

##### (2) 以太网发送的数据都使用**曼彻斯特** (Manchester) 编码

 ![image-20220316185321295](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185321.png/)

**曼彻斯特编码缺点是：它所占的频带宽度比原始的基带信号增加了一倍。**

#### 以太网提供的服务(**考点**)

- CSMA/CD 含义：**载波监听多点接入 / 碰撞检测** (Carrier Sense Multiple Access with Collision Detection) 。
- “**多点接入**”表示许多计算机以多点接入的方式连接在一根总线上。
- “**载波监听**”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 
  - 总线上并没有什么“载波”。因此， **“载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。**
- "**碰撞检测**"：适配器边发送数据，边检测信道上的信号电压的变化情况。电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞（或冲突）。

##### 碰撞检测

- “**碰撞检测**”就是计算机边发送数据边检测信道上的信号电压大小。
- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
- **所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。**

##### 检测到碰撞后

- 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
- **每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。**

#### CSMA/CD 协议工作流程

![image-20220316185627636](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185627.png/)

#### 为什么要进行碰撞检测？ 因为信号**传播时延**对载波监听产生了影响

![image-20220316185634858](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316185634.png/)

#### 争用期

- 最先发送数据帧的站，在发送数据帧后**至多**经过时间 2（**两倍的端到端往返时延**）就可知道发送的数据帧是否遭受了碰撞。
- 以太网的端到端往返时延 2 称为**争用期**，或**碰撞窗口**。
- **经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。**
- **争用期:51.2微秒**

#### 碰撞后后重传时机

**二进制指数类型退避算法** (truncated binary exponential type)

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。

1. **基本退避时间取为争用期 2  。**

2. 从整数集合 [0, 1, … , (2k - 1)] 中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。

3. 参数 k 按下面的公式计算：

   ​				**k = Min[重传次数, 10]**

4. 当 k ≤10 时，参数 k 等于重传次数。

5. 当重传达 **16** 次仍不能成功时即丢弃该帧，并向高层报告。 

*例如：*

*第 1 次冲突重传时：*
	*k = 1，r 为 {0，1} 集合中的任何一个数。*
*第 2 次冲突重传时：*
	*k = 2，r 为 {0，1，2，3} 集合中的任何一个数。*
*第 3 次冲突重传时：*
	*k = 3，r 为 {0，1，2，3，4，5，6，7} 集合中的任何一个数。*

![image-20220323143212594](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220323143212.png/)

#### 10 Mbit/s 以太网争用期的长度

- 10 Mbit/s 以太网取 **51.2 μs** 为争用期的长度。
- 对于 10 Mbit/s 以太网，在争用期内可发送 512 bit，即 64 字节。

这意味着：

- <u>以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突。</u>

- <u>最短有效帧长为64字节,长度小于64字节的帧都是无效帧,直接丢弃</u>

#### 最短有效帧长

- 如果发生冲突，就一定是在发送的前 64 字节之内。 
- 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。 
- 以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。

#### 覆盖范围

- 在 10 Mbit/s 以太网 51.2 μs 的争用期内，信号能传输多远的距离？
- 以太网上最大的端到端单程时延必须小于争用期的一半（即 **25.6 μs**），这相当于以太网的**最大**端到端长度约为 **5 km**。

#### 人为干扰信号

![image-20220316190246530](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190246.png/)

![image-20220323143955304](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220323143955.png/)

使接受数据的一方有时间处理数据

#### CSMA/CD 协议的重要特性

- 使用 CSMA/CD 协议的以太网不能进行全双工通信而只能进行**双向交替通信（半双工通信）**。
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 
- 这种**发送的不确定性**使整个以太网的平均通信量远小于以太网的最高数据率。 

#### CSMA/CD 协议的要点

![image-20220316190347634](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190347.png/)

### 3.3.3 使用集线器的星形拓扑

- 传统以太网最初是使用**粗同轴电缆**，后来演进到使用比较便宜的**细同轴电缆**，最后发展为使用更便宜和更灵活的**双绞线。**
- 采用双绞线的以太网采用**星形拓扑**
- 在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器** (hub)。

#### 传统以太网使用同轴电缆，采用总线形拓扑结构

![image-20220316190456708](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190456.png/)

#### 使用集线器的双绞线以太网 

![image-20220316190518268](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190518.png/)

#### 星形以太网 10BASE-T

![image-20220316190542600](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190542.png/)

- 使用无屏蔽双绞线，采用星形拓扑。
- 每个站需要用两对双绞线，分别用于发送和接收。
- 双绞线的两端使用 RJ-45 插头。
- 集线器使用了大规模集成电路芯片，因此集线器的可靠性提高。 
- 10BASE-T 的通信距离稍短，每个站到集线器的距离不超过 100m。

#### 10BASE-T 以太网在局域网中的统治地位

- 这种 10 Mbit/s 速率的无屏蔽双绞线星形网的出现，既降低了成本，又提高了可靠性。 具有很高的性价比。
- 10BASE-T 双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。
- 从此以太网的拓扑就从总线形变为更加方便的星形网络，而以太网也就在局域网中占据了统治地位。 

#### 集线器的一些特点

- 集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个**传统的以太网**那样运行。 
- **使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线。** 
- 集线器很像一个多接口的转发器，**工作在物理层**。
- 集线器采用了**专门的芯片**，进行自适应串音回波抵消，减少了近端串音。

#### 具有三个接口的集线器

 ![image-20220316190632921](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190633.png/)

### 3.3.4 以太网的信道利用率

- 多个站在以太网上同时工作就可能会发生碰撞。
- 当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，**以太网总的信道利用率并不能达到 100%**。
- 假设 是以太网单程端到端传播时延。则争用期长度为 2T ，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。
- 设帧长为 L (bit)，数据发送速率为 C (bit/s)，则帧的发送时间为 T0 = L/C (s)。 

#### 以太网信道被占用的情况

一个站在发送帧时出现了碰撞。经过一个争用期 2 后，可能又出现了碰撞。这样经过若干个争用期后，一个站发送成功了。假定发送帧需要的时间是 T0。

 ![image-20220316190723982](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190724.png/)

- 注意到，成功发送一个帧需要占用信道的时间是 T0 +  ，比这个帧的发送时间要多一个单程端到端时延  。
- 这是因为当一个站发送完最后一个比特时，这个比特还要在以太网上传播。
- 在最极端的情况下，发送站在传输媒体的一端，而比特在媒体上传输到另一端所需的时间是  。

####  参数 a 与利用率

- 要提高以太网的信道利用率，就必须减小  与 T0 之比。
- 在以太网中定义了参数 a ，它是以太网单程端到端时延  与帧的发送时间 T0 之比：

![image-20220316190857202](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316190857.png/)

**a → 0，表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高。**
**a 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。** 

##### 对以太网参数 a 的要求是：

- 为提高利用率，以太网的参数 a 的值应当**尽可能小**些。
- 当数据率一定时，以太网的连线的**长度受到限制**，否则  的数值会太大。
- 以太网的**帧长不能太短**，否则 T0 的值会太小，使 a 值太大。 

#### 信道利用率的最大值 Smax 

在理想化的情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是 CSMA/CD，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一个站立即发送数据。

发送一帧占用线路的时间是 T0 +  ，而帧本身的发送时间是 T0。于是，我们可计算出理想情况下的极限信道利用率 Smax 为： 

![image-20220316191012980](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191013.png/)

- **只有当参数 a 远小于 1 才能得到尽可能高的极限信道利用率。**
- **据统计，当以太网的利用率达到 30% 时就已经处于重载的情况。很多的网络容量被网上的碰撞消耗掉了。**

### 3.3.5 以太网的 MAC 层

#### 1. MAC 层的硬件地址

- 在局域网中，**硬件地址**又称为**物理地址**，或 **MAC 地址**。 
- 802 标准所说的“地址”严格地讲应当是每一个站的“**名字**”或**标识符**。 
- 主机网口ID
- 但鉴于大家都早已习惯了将这种 48 位的“名字”称为“地址”，所以本书也采用这种习惯用法，尽管这种说法并不太严格。

 <u>请注意，如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个“地址”。更准确些说，这种 48 位“地址”应当是某个接口的标识符。</u>

##### 48 位的 MAC 地址

- IEEE 802 标准规定 MAC 地址字段可采用 6 字节 ( 48位) 或 2 字节 ( 16 位) 这两种中的一种。
- IEEE 的注册管理机构 RA 负责向厂家分配地址字段 6 个字节中的**前三个字节 (即高位 24 位)**，称为**组织唯一标识符**。
- 地址字段 6 个字节中的**后三个字节** (即低位 24 位) 由厂家自行指派，称为**扩展唯一标识符**，**必须保证生产出的适配器没有重复地址**。

![image-20220316191217580](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191217.png/)

- 一个地址块可以生成 224 个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是 EUI-48。
- 生产适配器时，6 字节的 MAC 地址已被固化在适配器的 ROM，因此，MAC 地址也叫做**硬件地址** (hardware address) 或**物理地址**。
- “MAC 地址”实际上就是适配器地址或适配器标识符 EUI-48。

##### 单站地址，组地址，广播地址

- *IEEE 规定地址字段的第一字节的最低位为 I/G 位。I/G 表示 Individual / Group。*
- **当 I/G 位 = 0 时**，地址字段表示一个**单站地址**。
- **当 I/G 位 = 1 时**，表示**组地址**，用来进行多播（以前曾译为组播）。此时，IEEE 只分配地址字段前三个字节中的 23 位。
- 当 I/G 位分别为 0 和 1 时，一个地址块可分别生成 223 个单个站地址和 223 个组地址。
- 所有 48 位都为 1 时，为广播地址。只能作为目的地址使用。

##### 全球管理与本地管理

- *IEEE 把地址字段第一字节的最低第 2 位规定为 G/L 位，表示 Global / Local。*
- **当 G/L 位 = 0** 时，是**全球管理**（保证在全球没有相同的地址），厂商向 IEEE 购买的 OUI 都属于全球管理。
- **当 G/L 位 = 1** 时， 是**本地管理**，这时用户可任意分配网络上的地址。

##### 适配器检查 MAC 地址  过滤功能

- 适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址。
  - 如果是**发往本站的帧**则收下，然后再进行其他的处理。
  - 否则就将此帧丢弃，不再进行其他的处理。
- **“发往本站的帧”包括以下三种帧：** 
  - **单播** (unicast) 帧（一对一）
  - **广播** (broadcast) 帧（一对全体）
  - **多播** (multicast) 帧（一对多）

- 所有的适配器都至少能够识别前两种帧，即**能够识别单播地址和广播地址**。
- 有的适配器可用编程方法识别多播地址。
- **只有目的地址才能使用广播地址和多播地址。**
- 以**混杂方式** (promiscuous mode) 工作的以太网适配器只要“听到”有帧在以太网上传输就都接收下来。

#### 2. MAC 帧的格式

常用的以太网 MAC 帧格式有两种标准：

1. **DIX Ethernet V2 标准**
2. **IEEE 的 802.3 标准**

最常用的 MAC 帧是**以太网 V2 的格式**。

以太网 V2 的 MAC 帧格式

**最大1518字节长度**

![image-20220316191735185](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191735.png/) 

 ![image-20220316191753610](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191753.png/)

![image-20220316191804080](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191804.png/) 

 ![image-20220316191813291](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191813.png/)

![image-20220316191821061](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191821.png/) 

 ![image-20220316191827595](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316191827.png/)

##### 无效的 MAC 帧 

- 数据字段的长度与长度字段的值不一致；
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。如果不足,需要填充字段.
- 有效的 MAC 帧长度为 64 ~ **1518** 字节之间。

  <u>对于检查出的无效 MAC 帧就简单地丢弃。</u>

  <u>以太网不负责重传丢弃的帧。</u> (由传输层负责)

##### IEEE 802.3 MAC 帧格式

与以太网 V2 MAC 帧格式相似，区别在于：

![image-20220328134819307](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401085041.png)

- IEEE 802.3 规定的 MAC 帧的第三个字段是“**长度 / 类型**”。
  - 当这个字段值**大于** 0x0600 时（相当于十进制的 1536），就表示“**类型**”。这样的帧和以太网 V2 MAC 帧完全一样。
  - 当这个字段值**小于** 0x0600 时才表示“长度”,数据字段必须**装入**上面的逻辑链路控制 LLC 子层的 **LLC 帧**。

<u>现在市场上流行的都是以太网 V2 的 MAC 帧，但大家也常常把它称为 IEEE 802.3 标准的 MAC 帧。</u>(兼容两个协议)

##### 帧间最小间隔

- 帧间最小间隔为 9.6 s，相当于 96 bit 的发送时间。
- 一个站在检测到总线开始空闲后，还要等待 9.6 s 才能再次发送数据。
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。 

## 3.4扩展的以太网

### 3.4.1 在物理层扩展以太网

#### 使用光纤扩展

- 主机使用光纤（通常是一对光纤）和一对光纤调制解调器连接到集线器。 
- 很容易使主机和几公里以外的集线器相连接。

![image-20220316192029434](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192029.png/)

#### 使用集线器扩展：

将多个以太网段连成更大的、多级星形结构的以太网。

![image-20220316192115661](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192115.png/)

##### 优点

1. 使原来属于不同碰撞域的以太网上的计算机能够进行**跨碰撞域的通信**。
2. 扩大了以太网覆盖的地理范围。

##### 缺点

1. 碰撞域增大了，但总的吞吐量并未提高。
2. 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。 

####  碰撞域

- **碰撞域**（collision domain）又称为**冲突域**，是指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。
- 碰撞域越大，发生碰撞的概率越高。

![image-20220316192222034](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192222.png/)

### 3.4.2 在数据链路层扩展以太网

- 扩展以太网更常用的方法是在数据链路层进行。
- 早期使用**网桥**，现在使用以太网**交换机**。

![image-20220316192250676](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192250.png/)

#### 网桥与以太网交换机

**网桥**

- 网桥工作在数据链路层。
- 它根据 MAC 帧的目的地址对收到的帧进行转发和过滤。
- 当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口，或把它丢弃。

**交换机**

- 1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能。
- 交换式集线器常称为以太网交换机 (switch) 或第二层交换机 (L2 switch)，强调这种交换机工作在数据链路层。

#####  1. 以太网交换机的特点

- 以太网交换机实质上就是一个**多接口的网桥**。
  - 通常都有十几个或更多的接口。
- 每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都**工作在全双工方式**。
- 以太网交换机**具有并行性**。
  - 能同时连通多对接口，使多对主机能同时通信。

- 相互通信的主机都是独占传输媒体，**无碰撞**地传输数据。

![image-20220316192425228](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192425.png/)

###### 实现分别碰撞域的原因

- 以太网交换机的**接口有存储器**，能在输出端口繁忙时把到来的帧进行缓存。
- 以太网交换机是一种**即插即用**设备，其内部的帧**交换表**（又称为**地址表**,一种内容可寻址存储器）是通过**自学习算法**自动地逐渐建立起来的。
- 以太网交换机使用了**专用的交换结构芯片**，用硬件转发，其转发速率要比使用软件转发的网桥快很多。

<u>以太网交换机的性能远远超过普通的集线器，而且价格并不贵。</u>

###### 以太网交换机的优点

- 用户独享带宽，增加了总容量。
  - ![image-20220316192646772](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192646.png/)
- 从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动。
- 以太网交换机一般都具有多种速率的接口，方便了各种不同情况的用户。

###### 以太网交换机的交换方式

- **存储转发方式**
  - 把整个数据帧**先缓存**后再进行处理。

- **直通 (cut-through) 方式**
  - 接收数据帧的同时就**立即按数据帧的目的 MAC 地址决定该帧的转发接口**，因而**提高了帧的转发速度**。
  - **缺点**是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。

 <u>在某些情况下，仍需要采用基于软件的存储转发方式进行交换，例如，当需要进行线路速率匹配、协议转换或差错检测时。</u>

![image-20220316192806120](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192806.png/)

##### 2. 以太网交换机的自学习功能

- 以太网交换机运行自学习算法自动维护交换表。

  ![image-20220316192853673](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192853.png/)

  ![image-20220316192910622](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192910.png/) 

  ![image-20220316192935414](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192935.png/)
  
  ![image-20220316192949581](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316192949.png/)
  
  ![image-20220316193021814](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193021.png/)

###### 交换机自学习和转发帧的步骤归纳

![image-20220316193103173](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193103.png/)

###### 理解以太网交换机的自学习功能

假设：A 向 B 发送了一帧，C 向 E 发送了一帧，E 向 A 发送了一帧。

请分析：此时，S1 和 S2 的交换表内容分别是什么？

![image-20220316193135310](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193135.png/)

![image-20220316193156813](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193156.png/)

**存在的问题：回路**

![image-20220316193210873](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193210.png/)

###### 如何解决回路问题

- IEEE 802.1D 标准制定了一个**生成树协议STP**  (Spanning Tree Protocol)。
- 其要点是：**不改变**网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是**无环路的树状结构**，从而消除了兜圈子现象。

![image-20220316193346986](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193347.png/)

##### 3. 虚拟局域网

- 早期，以太网采用无源的总线结构。
- 现在，采用以太网交换机的星形结构成为以太网的首选拓扑。
- 总线以太网使用 CSMA/CD 协议，以半双工方式工作。
- 以太网交换机不使用共享总线，没有碰撞问题，因此不使用 CSMA/CD 协议，以全双工方式工作。**但仍然采用以太网的帧结构。**

![image-20220316193419562](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193419.png/)

###### 局域网存在的问题

- 局域网存在的以下几个方面的问题：
  - 广播风暴:广播数据充斥网络无法处理，并占用大量网络带宽，导致正常业务不能运行，甚至彻底瘫痪
  - 安全性
  - 管理困难

###### 广播风暴

-  所有计算机都处于**同一个碰撞域**（或冲突域）中和**同一个广播域**中。

![image-20220316193509492](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193509.png/)

![image-20220316193545491](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193545.png/)

-  **广播域（broadcast domain）**：指这样一部分网络，其中任何一台设备发出的广播通信都能被该部分网络中的所有其他设备所接收。

![image-20220316193558621](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193558.png/)

###### 安全问题

-  每个接口都处于一个独立的碰撞域（或冲突域）中，但所有计算机都处于同一个广播域中。

![image-20220316193708179](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193708.png/)

![image-20220316193714361](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193714.png/)

### 3.4.3 虚拟局域网

- 利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。

- **IEEE 802.1Q** 对虚拟局域网 **VLAN** 的**定义**：

  虚拟局域网 VLAN 是由一些局域网网段构成的与**物理位置无关的逻辑组**，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN。

- **虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。**

- 由于虚拟局域网是用户和网络资源的逻辑组合，因此可按照需要将有关设备和资源非常方便地重新组合，使用户从不同的服务器或数据库中存取所需的资源。

![image-20220316193809075](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193809.png/)

![image-20220316193832711](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193832.png/)

![image-20220316193849834](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193849.png/)

![image-20220316193856202](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193856.png/)

#### 虚拟局域网优点

- 虚拟局域网（VLAN）技术具有以下主要优点：
  - 改善了性能
  - 简化了管理
  - 降低了成本
  - 改善了安全性

#### 划分虚拟局域网的方法

- 基于交换机端口
- 基于计算机网卡的MAC地址
- 基于协议类型
- 基于IP子网地址
- 基于高层应用或服务

##### 1.基于交换机端口的方法

- 最简单、也是最常用的方法。
- 属于在第一层划分虚拟局域网的方法。
- **缺点**：不允许用户移动。

![img](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316193940.png/)

##### 2.基于计算机网卡的MAC地址的方法

- 根据用户计算机的MAC地址划分虚拟局域网。
- 属于在第二层划分虚拟局域网的方法。
- 允许用户移动。
- **缺点**：需要输入和管理大量的MAC地址。如果用户的MAC地址改变了，则需要管理员重新配置VLAN。

![image-20220316194054209](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194054.png/)

##### 3.基于协议类型的方法

- 根据以太网帧的第三个字段“类型”字段确定该类型的协议属于哪一个虚拟局域网。
- 属于在第二层划分虚拟局域网的方法。

![image-20220316194047311](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194047.png/)

##### 4.基于IP子网地址的方法

- 根据以太网帧的第三个字段“类型”字段和IP分组首部中的**源 IP 地址**字段确定该 IP 分组属于哪一个虚拟局域网。
- 属于在第三层划分虚拟局域网的方法。

![image-20220316194129956](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194130.png/)

##### 5.基于高层应用或服务的方法

- 根据高层应用或服务、或者它们的组合划分虚拟局域网。
- 更加灵活，但更加复杂。

![image-20220316194142734](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194142.png/)

- IEEE 批准了 802.3ac 标准，该标准定义了以太网的帧格式的扩展，以支持虚拟局域网。
- 虚拟局域网协议允许在以太网的帧格式中插入一个4字节的标识符，称为 **VLAN 标记** (tag)，用来指明该帧属于哪一个虚拟局域网。
- 插入VLAN标记得出的帧称为 **802.1Q** 帧或带标记的以太网帧。

#### 虚拟局域网使用的以太网帧格式

![image-20220316194207542](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194207.png/)

![image-20220316194218586](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194218.png/)

## 3.5高速以太网

### 3.5.1 100BASE-T 以太网

- **速率达到或超过 100 Mbit/s 的以太网称为高速以太网。**
- 100BASE-T 在双绞线上传送 100 Mbit/s 基带信号的星形拓扑以太网，仍使用 IEEE 802.3 的 CSMA/CD 协议。
- 100BASE-T 以太网又称为**快速以太网** (Fast Ethernet)。
- 1995 年IEEE已把 100BASE-T 的快速以太网定为正式标准，其代号为 **IEEE 802.3u。**

#### 100BASE-T 以太网的特点

- 可在全双工方式下工作而无冲突发生。**在全双工方式下工作时，不使用 CSMA/CD 协议。**
- **MAC 帧格式仍然是 802.3 标准规定的。**
- **保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 米。**
- 帧间时间间隔从原来的 9.6 s 改为现在的 0.96 s 。 

####  100 Mbit/s 以太网的三种不同的物理层标准

- 100BASE-TX
  - **使用 2 对 UTP 5 类线 或 屏蔽双绞线 STP。**
  - **网段最大程度：100 米。**
- 100BASE-T4
  - **使用 4 对 UTP 3 类线 或 5 类线。** 
  - **网段最大程度：100 米。**
- 100BASE-FX 
  - **使用 2 对光纤。** 
  - **网段最大程度：2000 米。**

### 3.5.2 吉比特以太网

- 允许在 1 Gbit/s 下以全双工和半双工两种方式工作。
- 使用 IEEE 802.3 协议规定的帧格式。
- **在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。**
- 与 10BASE-T 和 100BASE-T 技术向后兼容。

<u>吉比特以太网可用作现有网络的主干网，也可在高带宽（高速率）的应用场合中。</u>

#### 吉比特以太网的物理层

使用两种成熟的技术：一种来自现有的以太网，另一种则是美国国家标准协会 ANSI 制定的光纤通道 FC (Fiber Channel)。

#### 半双工方式工作的吉比特以太网

- 吉比特以太网工作在半双工方式时，就必须进行碰撞检测。
- 为保持 64 字节最小帧长度，以及 100 米的网段的最大长度，吉比特以太网增加了两个功能：
  - **载波延伸** (carrier extension)
  - **分组突发** (packet bursting)

#####  载波延伸

- 使最短帧长仍为 64 字节（这样可以保持兼容性），同时**将争用时间增大为 512 字节。**
- 凡发送的 MAC 帧长不足 512 字节时，就用一些特殊字符填充在帧的后面，使MAC 帧的发送长度增大到 512 字节。接收端在收到以太网的 MAC 帧后，要将所填充的特殊字符删除后才向高层交付。
  - ![image-20220316194614822](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194614.png/)

##### 分组突发

- 当很多短帧要发送时，第一个短帧要采用载波延伸方法进行填充，随后的一些短帧则可一个接一个地发送，只需留有必要的帧间最小间隔即可。这样就形成可一串分组的突发，直到达到 1500 字节或稍多一些为止。
  - ![image-20220316194634854](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220316194634.png/)

#### 全双工方式工作的吉比特以太网

-  当吉比特以太网工作在全双工方式时（即通信双方可同时进行发送和接收数据），**不使用载波延伸和分组突发。**

### 3.5.3  10 吉比特以太网和更快的以太网

- 10 吉比特以太网（10GE）并非把吉比特以太网的速率简单地提高到 10 倍，其主要特点有：

1. 与 10 Mbit/s、100 Mbit/s 和 1 Gbit/s 以太网的帧格式完全相同。
2. 保留了 802.3 标准规定的以太网最小和最大帧长，便于升级。
3. 不再使用铜线而只使用光纤作为传输媒体。
4. **只工作在全双工方式**，因此没有争用问题，也不使用 CSMA/CD 协议。 

#### 端到端的以太网传输

- 以太网的工作范围已经从局域网（校园网、企业网）扩大到城域网和广域网，**从而实现了端到端的以太网传输。**
- 这种工作方式的好处有： 
  1. 技术成熟；
  2. 互操作性很好；
  3. 在广域网中使用以太网时价格便宜；
  4. 采用统一的以太网帧格式，简化了操作和管理。 

### 3.5.4 使用以太网进行宽带接入

- IEEE 在 2001 年初成立了 802.3 EFM 工作组，专门研究高速以太网的宽带接入技术问题。
- 以太网宽带接入具有以下**特点**：
  1. 可以提供**双向**的宽带通信。
  2. 可以根据用户对带宽的需求灵活地进行带宽**升级**。
  3. 可以实现端到端的以太网传输，中间**不需要再进行帧格式的转换**。这就提高了数据的传输效率且降低了传输的成本。
  4. **但是不支持用户身份鉴别。**

#### PPPoE

- **PPPoE** (PPP over Ethernet) 的意思是“在以太网上运行 PPP”，它把 PPP 协议与以太网协议结合起来 —— 将 PPP 帧再封装到以太网中来传输。
- 现在的光纤宽带接入 FTTx 都要使用 PPPoE 的方式进行接入。在 PPPoE 弹出的窗口中键入在网络运营商购买的用户名和密码，就可以进行宽带上网了。
- 利用 ADSL 进行宽带上网时，从用户个人电脑到家中的 ADSL 调制解调器之间，也是使用 RJ-45 和 5 类线（即以太网使用的网线）进行连接的，并且也是使用 PPPoE 弹出的窗口进行拨号连接的。

#  第 4 章 网 络 层

## 4.1  网络层提供的两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”）曾引起了长期的争论。
争论焦点的实质就是：**在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？** 

#### 一种观点：让网络负责可靠交付

- 这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用**面向连接**的通信方式。
- 通信之前先建立**虚电路** (Virtual Circuit)，以保证双方通信所需的一切网络资源。 
- 如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

![image-20220319191607720](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319191607.png/)

##### 虚电路是逻辑连接

- 虚电路表示这只是一条**逻辑上的连接**，分组都沿着这条逻辑连接**按照存储转发方式传送**，而并不是真正建立了一条物理连接。
- 请注意，电路交换的电话通信是先建立了一条**真正的连接**。
- 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。 

#### 另一种观点：网络提供数据报服务

- 互联网的先驱者提出了一种崭新的网络设计思路。
- 网络层向上只提供**简单**灵活的、**无连接的、尽最大努力交付的数据报服务**。
- 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
- **网络层不提供服务质量的承诺**。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。 

##### 尽最大努力交付

- 由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。
- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责可靠交付（包括差错处理、流量控制等） 
- 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。

- 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。 

##### 数据报服务

![image-20220319195243138](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195243.png/)

#### 虚电路服务与数据报服务的对比

![image-20220319195336759](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195336.png/)

### 4.1.2网络层两个层面

不同网络的两个主机之间的通信,要经过若干个路由器转发分组完成

在路由器之间传送的信息有两大类

- 用户数据
- 控制层面

![image-20220401091531063](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401091531.png)

![image-20220401091802964](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401091803.png)

![image-20220401091818327](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401091818.png)

## 4.2 网际协议IP

- 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。
- 与 IPv4 协议配套使用的还有三个协议：
  - **地址解析协议** **ARP** (Address Resolution Protocol)---硬件地址和IP地址映射
  - **网际控制报文协议** **ICMP** (Internet Control Message Protocol)---
  - **网际组管理协议** **IGMP** (Internet Group Management Protocol)

![image-20220319195457093](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195457.png/)

### 4.2.1虚拟互联网络(Internet Group Management Protocol)

![image-20220401092505501](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401092506.png)



- 将网络互连并能够互相通信，会遇到许多问题需要解决，如：
  - 不同的寻址方案
  - 不同的最大分组长度
  - 不同的网络接入机制
  - 不同的超时控制
  - 不同的差错恢复方法
  - 不同的状态报告方法
  - 不同的路由选择技术
  - 不同的用户接入控制
  - 不同的服务（面向连接服务和无连接服务）
  - 不同的管理与控制方式等

**如何将异构的网络互相连接起来？**

![image-20220401092656930](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401092743.png)

#### 使用一些中间设备进行互连

- 将网络互相连接起来要使用一些中间设备。 

- 中间设备又称为**中间系统**或中继 (relay)系统。

- 有以下五种不同的中间设备：
  - **物理层**中继系统：**转发器** (repeater)。
  - **数据链路层**中继系统：**网桥** 或 **桥接器** (bridge)。
  - **网络层**中继系统：**路由器** (router)。
  - 网桥和路由器的**混合物**：**桥路器** (brouter)。
  - **网络层以上**的中继系统：**网关** (gateway)。 
  
  ![image-20220401093125867](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401093126.png)

#### 网络互连使用路由器

- 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。 

![image-20220401093225760](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401093226.png)

- 网关由于比较复杂，目前使用得较少。
- **网络互连都是指用路由器进行网络互连和路由选择**。
- 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为**网关**。  

#### 互连网络与虚拟互连网络

![image-20220319195826254](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195826.png/)

#### 虚拟互连网络的意义

- **所谓虚拟互连网络也就是逻辑互连网络**，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP **协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络**。
- 使用 IP 协议的虚拟互连网络可简称为 IP 网。
- **使用虚拟互连网络的好处是**：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。
- **如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)**

![image-20220319195901292](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195901.png/)

#### 分组传输路径

![image-20220401094329434](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401094330.png)

#### 从网络层看 IP 数据报的传送

- 如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层中传送。
  - ![image-20220319195918210](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319195918.png/)

### 4.2.2 分类的 IP 地址

- 在 TCP/IP 体系中，IP 地址是一个最基本的概念。
- 本部分重点学习：
  - **IP 地址及其表示方法**
  - **常用的三种类别的 IP 地址**

#### \1.  IP 地址及其表示方法

- 我们把整个互联网看成为一个单一的、抽象的网络。
- IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是**唯一的 32 位的标识符。**
- IP 地址现在由**互联网名字和数字分配机构ICANN** (Internet Corporation for Assigned Names and Numbers)进行分配。

![image-20220401095113334](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401095113.png)

##### IP 地址的编址方法

**分类的 IP 地址**。这是**最基本的编址方法**，在1981年就通过了相应的标准协议。

**子网的划分**。这是对最基本的编址方法的**改进**，其标准[RFC 950]在1985年通过。

**构成超网**。这是比较新的**无分类编址方法**。1993年提出后很快就得到推广应用。

##### 分类 IP 地址

- 将IP地址划分为若干个固定类。
- 每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机（或路由器）。
- 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，**一个 IP 地址在整个互联网范围内是唯一的**。

这种两级的 IP 地址结构如下：

![image-20220319200104835](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200104.png/)

这种两级的 IP 地址可以记为：

![image-20220319200113849](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200113.png/)

##### 各类 IP 地址的网络号字段和主机号字段

![image-20220319200138817](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200138.png/)

![image-20220319200146809](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200146.png/)

![image-20220319200156245](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200156.png/)

![image-20220319200203673](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200203.png/)

![image-20220319200208547](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200208.png/)

![image-20220319200221008](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200221.png/)

![image-20220319200226153](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200226.png/)

![image-20220319200232557](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200232.png/)

![image-20220319200237572](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200237.png/)

##### 点分十进制记法

![image-20220319200303207](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200303.png/)

##### 点分十进制记法举例

![image-20220319200320060](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200320.png/)

#### \2. 常用的三种类别的 IP 地址 

![image-20220319200337183](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200337.png/)

#### 一般不使用的特殊的 IP 地址

![image-20220319200353750](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200353.png/)

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401101052.png" alt="image-20220401101051971" style="zoom: 67%;" />

#### 分类IP优缺点

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401101831.png" alt="image-20220401101830694" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220401102046.png" alt="image-20220401102045996" style="zoom:50%;" />

##### IP 地址的一些重要特点

**(1) IP 地址是一种分等级的地址结构。**分两个等级的好处是：

- 第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
- 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

IP 地址的一些重要特点

**(2) 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。**

- 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。**这种主机称为多归属主机 (multihomed host)。**
- 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址。** 

**(3) 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。**

**(4) 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。**

##### 互联网中的 IP 地址

![image-20220319200516600](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200516.png/)

- 在同一个局域网上的主机或路由器的IP 地址中的网络号必须是一样的。图中的网络号就是 IP 地址中的 net-id。
- 路由器总是具有两个或两个以上的IP地址。路由器的每一个接口都有一个不同网络号的IP地址。
- 两个路由器直接相连的接口处，可指明也可不指明IP地址。如指明IP地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” 。现在常不指明IP地址。

### 4.2.3 IP 地址与硬件地址

- IP 地址与硬件地址是不同的地址。
- 从层次的角度看，
  - **硬件地址**（或物理地址）是数据链路层和物理层使用的地址。
  - **IP 地址**是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）。

### 4.2.3 IP 地址与硬件地址

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404144832.png" alt="image-20220404144832360" style="zoom:50%;" />

![image-20220319200656293](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200656.png/)

![image-20220319200704187](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200704.png/)

![image-20220319200711515](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200711.png/)

![image-20220319200717492](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200717.png/)

![image-20220319200722897](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200723.png/)

![image-20220319200729608](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200729.png/)

- 路由器只根据目的站的 IP 地址的网络号进行路由选择。 
- 在具体的物理网络的链路层只能看见 MAC 帧而看不见 IP 数据报 
- IP 层抽象的互联网屏蔽了下层很复杂的细节。在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信 。

##### 主机 H1 与 H2 通信中使用的IP地址 与 硬件地址 HA

**IP数据表中原地址目的地址不变,MAC帧中不断变化**

![image-20220319200927828](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200927.png/)

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404145952.png" alt="image-20220404145952603" style="zoom:50%;" />

### 4.2.4  地址解析协议 ARP

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406133249.png" alt="image-20220406133249335" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406133451.png" alt="image-20220406133451530" style="zoom:50%;" />

- 通信时使用了两个地址：
  - **IP 地址（网络层地址）**
  - **MAC 地址（数据链路层地址）**

![image-20220319200959209](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319200959.png/)

#### 地址解析协议 ARP 的作用

- 已经知道了一个机器（主机或路由器）的IP地址，如何找出其相应的硬件地址？
- 地址解析协议 ARP 就是用来解决这样的问题的。
- **从IP地址解析出MAC地址**


![image-20220319201550979](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319201551.png/)

#### 地址解析协议 ARP 要点3

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

- 每一个主机都设有一个 **ARP 高速缓存** (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

![image-20220319201607136](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319201607.png/)

- 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
  - **如有**，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
  - **如没有**， ARP 进程在本局域网上**广播发送**一个<u>**ARP 请求分组**</u>。收到 **ARP 响应分组**后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

- **ARP请求分组**：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。
- **本地广播 ARP 请求**（路由器不转发ARP请求）。
- **ARP 响应分组**：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。
- **ARP 分组封装在物理网络的帧中传输。**

![image-20220406134054768](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406134054.png)

#### ARP 高速缓存的作用

- **存放最近获得的 IP 地址到 MAC 地址的绑定，以<u>减少 ARP 广播的数量</u>。**
- 为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。
- 当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。 

##### 应当注意的问题

![image-20220406134526607](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406134526.png)

- **ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。**
- 如果所要找的主机和源主机不在同一个局域网上，那么**就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址**，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。


- 从 IP 地址到硬件地址的**解析是自动进行**的，主机的用户对这种地址解析过程是不知道的。
- 只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406134815.png" alt="image-20220406134815461" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406134920.png" alt="image-20220406134920500" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406134954.png" alt="image-20220406134953919" style="zoom:50%;" />


##### 使用 ARP 的四种典型情况

![image-20220319201755900](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319201756.png/)

- 发送方是**主机**，要把 IP 数据报发送到**本网络上的另一个主机**。这时用 ARP 找到目的主机的硬件地址。 

- 发送方是**主机**，要把 IP 数据报发送到**另一个网络上的一个主机**。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

- 发送方是**路由器**，要把 IP 数据报转发到**本网络上的一个主机**。这时用 ARP 找到目的主机的硬件地址。 

- 发送方是**路由器**，要把 IP 数据报转发到**另一个网络上的一个主机**。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

##### 为什么<u>不直接使用硬件地址</u>进行通信？ 

- 由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

- **IP 编址把这个复杂问题解决了。**连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。
- **因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。**

### 4.2.5 IP 数据报的格式

- 一个 IP 数据报由**首部**和**数据**两部分组成。

- **首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。**
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。 


![image-20220319202140988](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202141.png/)

![image-20220319202126974](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202127.png/)

![image-20220319202132905](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202133.png/)

#### \1. IP 数据报首部的固定部分中的各字段

![image-20220319202410359](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202410.png/)

- **版本**——占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。
- **首部长度**——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。
- **区分服务**——占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段 
- **总长度**——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元MTU。 
- **标识**(identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识。 
- **标志**(flag) ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF=1 表示后面“还有分片”。MF=0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF=0 时才允许分片。 
- **片偏移**——占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。

##### 【例4-1】 IP 数据报分片

- 一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。

- 因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。

- 于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。


- **原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。**

![image-20220319202844617](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202844.png/)

![image-20220319202850879](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202850.png/)

#### \1. IP 数据报首部的固定部分中的各字段

![image-20220319202913016](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202913.png/)

- **生存时间**——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。

- **协议**——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程

![image-20220319202944072](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319202944.png/)

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406143156.png" alt="image-20220406143156117" style="zoom:50%;" />

- **首部检验和**——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。 

![image-20220319203038319](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319203038.png/)

- 源地址和目的地址都各占 4 字节

#### \2. IP 数据报首部的可变部分

- IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。

- 选项字段的长度可变，**从 1 个字节到 40 个字节不等**，取决于所选择的项目。

- 增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。

- **实际上这些选项很少被使用**。

### 4.2.6 IP 层转发分组的流程

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406144426.png" alt="image-20220406144426208" style="zoom:50%;" />

- 假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。

- 可以想象，**若按目的主机号来制作路由表**，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。

- **但若按主机所在的网络地址来制作路由表**，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使**路由表大大简化。** 

![image-20220319203711517](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319203711.png/)

#### 例子

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406144656.png" alt="image-20220406144655727" style="zoom:50%;" />

#### 基于终点的转发

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220406144226.png" alt="image-20220406144225969" style="zoom:50%;" />

#### 查找路由表

**根据目的网络地址**就能确定下一跳路由器，这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的**间接交付**）。

- 只有到达最后一个路由器时，才试图向目的主机进行**直接交付**。 

#### 转发表中特殊的2个路由

##### 主机路由/特定主机路由

- 虽然互联网所有的分组转发都是**基于目的主机所在的网络**，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。
- 采用**特定主机路由**可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。 
- 网络前缀就是a.b.c.d/32
- 放在转发表最前面


##### 默认路由 (default route)

- 路由器还可采用**默认路由**以**减少路由表所占用的空间和搜索路由表所用的时间**。

- 这种转发方式在一个网络只有很少的对外连接时是很有用的。

- 默认路由在主机发送 IP 数据报时往往更能显示出它的好处。


- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。 
- 网络前缀0.0.0.0/32


##### 默认路由举例

![image-20220319203927500](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319203927.png/)

#### 必须强调指出

- IP 数据报的首部中**没有**地方可以用来指明“下一跳路由器的 IP 地址”。

- 当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是**送交下层**的网络接口软件。

- 网络接口软件**使用 ARP** 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。


#### 路由器分组转发算法

- 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
- 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行 (3)。
- 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行 (4)。
- 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行 (5)。
- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行 (6)。
- 报告转发分组出错。 

![image-20220411135905359](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411135905.png)


#### 关于路由表

- 路由表没有给分组指明到某个网络的完整路径。

- **路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。**
- 在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。

- 这样一步一步地查找下去，直到最后到达目的网络。


## 4.3 划分子网和构造超网

### 4.3.1  划分子网

在 ARPANET 的早期，IP 地址的设计确实不够合理：

(1) IP 地址空间的利用率有时很低。 

(2) 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。 

(3) 两级的 IP 地址不够灵活。

#### \1. 从两级 IP 地址到三级 IP 地址 

##### 三级 IP 地址

- 从 1985 年起在 IP 地址中又增加了一个“**子网号字段**”，使两级的 IP 地址变成为**三级的 IP 地址**。

- 这种做法叫做**划分子网** (subnetting) 。

- 划分子网已成为互联网的正式标准协议。 


##### 划分子网的基本思路

- 划分子网纯属一个**单位内部的事情**。单位对外仍然表现为没有划分子网的网络。

- 从主机号**借用**若干个位作为**子网号** subnet-id，而主机号 host-id 也就相应减少了若干个位。


![image-20220319204150716](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204150.png/)

- 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号 net-id**，先找到连接在**本单位网络上的路由器**。

- 然后**此路由器**在收到 IP 数据报后，再按**目的网络号** net-id 和**子网号** subnet-id 找到目的子网。

- 最后就将 IP 数据报直接交付目的主机。 


![image-20220319204238512](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204238.png/)

![image-20220319204244454](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204244.png/)

##### 划分子网后变成了三级结构

- 当没有划分子网时，IP 地址是两级结构。

- 划分子网后 IP 地址就变成了**三级结构**。

- 划分子网只是把 IP 地址的主机号 host-id 这部分进行再划分，而**不改变 IP 地址原来的网络号 net-id**。

  ​	![image-20220319204322171](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204322.png/) 

##### 优点

- 减少了 IP 地址的浪费

- 使网络的组织更加灵活

- 更便于维护和管理


**划分子网纯属一个单位内部的事情**，对外部网络透明，对外仍然表现为没有划分子网的一个网络。

#### \2. 子网掩码

- 从一个 IP 数据报的首部并**无法判断**源主机或目的主机所连接的网络是否进行了子网划分。

- 使用**子网掩码** (subnet mask) 可以找出 IP 地址中的子网部分。 


规则：

- 子网掩码长度 ＝ 32 位

- 子网掩码左边部分的一连串 1，对应于网络号和子网号

- 子网掩码右边部分的一连串 0，对应于主机号 


##### IP 地址的各字段和子网掩码

![image-20220319204440973](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204441.png/)

![image-20220319204446043](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204446.png/)

![image-20220319204453420](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204453.png/)

##### 子网掩码是一个重要属性

- **子网掩码是一个网络或一个子网的重要属性**。
- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。

- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。

- 若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。


##### 子网划分方法

- 有**固定长度子网**和**变长子网**两种子网划分方法。

- **在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。**
- 虽然根据已成为互联网标准协议的 RFC 950 文档，子网号不能为全 1 或全 0，但随着无分类域间路由选择 CIDR 的广泛使用，现在全 1 和全 0 的子网号也可以使用了，但一定要谨慎使用，确认你的路由器所用的路由选择软件是否支持全 0 或全 1 的子网号这种较新的用法。

- **划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。**

![image-20220319204544277](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204544.png/)

![image-20220319204557128](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204557.png/)

### 4.3.2 使用子网时分组的转发

- 在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事。

- 但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，**但数据报的首部并没有提供子网掩码的信息**。

- 因此分组转发的算法也必须做相应的改动。

#### 在划分子网情况下路由器转发分组的算法

- 从收到的分组的首部提取目的 IP 地址 D。

- 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。

- 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行 (4)。

- 对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。

- 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)。

- 报告转发分组出错。




<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204653.png/" alt="image-20220319204652839" style="zoom:67%;" />

<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204714.png/" alt="image-20220319204714140" style="zoom:67%;" />

<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204719.png/" alt="image-20220319204719288" style="zoom:67%;" />

<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204724.png/" alt="image-20220319204723994" style="zoom:67%;" />

<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204729.png/" alt="image-20220319204729558" style="zoom:67%;" />

<img src="https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319204738.png/" alt="image-20220319204738036" style="zoom:67%;" />

### 4.3.3 无分类编址 CIDR

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404133349.png" alt="image-20220404133349684" style="zoom:33%;" />

#### \1. 网络前缀

划分子网在一定程度上缓解了互联网在发展中遇到的困难。然而在 1992 年互联网仍然面临三个必须尽早解决的问题：

- B 类地址在 1992 年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕！

- 互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。

- 整个 IPv4 的地址空间最终将全部耗尽。


##### IP 编址问题的演进

- 1987 年，RFC 1009 就指明了在一个划分子网的网络中可同时使用几个不同的子网掩码。

- **使用变长子网掩码** VLSM (Variable Length Subnet Mask)可进一步提高 IP 地址资源的利用率。
- 在 VLSM 的基础上又进一步研究出**无分类编址方法**，它的正式名字是无分类域间路由选择 CIDR (Classless Inter-Domain Routing)。 


##### CIDR 最主要的特点

- CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

- CIDR使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。

- **IP 地址从三级编址（使用子网掩码）又回到了两级编址。** 

##### 无分类的两级编址

- 无分类的两级编址的记法是： 
- ![image-20220319205229204](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205229.png/)
- CIDR 使用“**斜线记法**”(slash notation)，它又称为 CIDR 记法，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24


##### CIDR 地址块

- CIDR 把网络前缀都相同的连续的 IP 地址组成“**CIDR 地址块**”。

- 128.14.32.0/20 表示的地址块**共有 2^12^ 个地址**（因为**斜线后面的 20 是网络前缀的位数**，所以这个地址的主机号是 12 位）。
  1. 这个地址块的起始地址是 128.14.32.0。
  2. 在不需要指出地址块的起始地址时，也可将这样的地址块简称为“**/20 地址块**”。
  3. 128.14.32.0/20 地址块的最小地址：128.14.32.0
  4. 128.14.32.0/20 地址块的最大地址：128.14.47.255
  5. **全 0 和全 1 的主机号地址一般不使用。**

![image-20220319205438893](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205439.png/)

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404134910.png" alt="image-20220404134910456" style="zoom: 50%;" />

#### (3)子网掩码

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404135049.png" alt="image-20220404135048977" style="zoom: 50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404135416.png" alt="image-20220404135407616" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404135909.png" alt="image-20220404135900146" style="zoom:50%;" />

- 


##### CIDR 记法的其他形式

- 10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略。

- 10.0.0.0/10 隐含地指出 IP 地址 10.0.0.0 的掩码是 255.192.0.0。此掩码可表示为：

- 网络前缀的后面加一个星号 * 的表示方法，如 00001010 00*，在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值。 


![image-20220319205646108](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205646.png/)

![image-20220319205652951](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205653.png/)

##### 构成超网

- 前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C 类地址。
- 这些 C 类地址合起来就构成了超网。
- **CIDR 地址块中的地址数一定是 2 的整数次幂。**
- 网络前缀越短，其地址块所包含的地址数就越多。**而在三级结构的IP地址中，划分子网是使网络前缀变长。**
- CIDR 的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR 地址块。

##### 路由聚合 (route aggregation) 

- 一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为**路由聚合**，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。

- 路由聚合有利于**减少**路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

- **路由聚合也称为构成超网 (supernetting)。**
- CIDR 虽然不使用子网了，但仍然使用“**掩码**”这一名词（但不叫子网掩码）。

- 对于 **/20** 地址块，它的掩码是 20 个连续的 1。 斜线记法中的数字就是掩码中1的个数。 

/24降为/20


##### CIDR 地址块划分举例

![image-20220319205747332](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205747.png/)

![image-20220319205756017](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205756.png/)

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404143158.png" alt="image-20220404143158172" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404141744.png" alt="image-20220404141019113" style="zoom:50%;" />

#### 4.IP地址特点

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404143240.png" alt="image-20220404143240297" style="zoom:50%;" />



<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404143723.png" alt="image-20220404143649298" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404143827.png" alt="image-20220404143827530" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220404144525.png" alt="image-20220404144524850" style="zoom:50%;" />





#### \2. 最长前缀匹配

- 使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。**在查找路由表时可能会得到不止一个匹配结果。** 
- 应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配 (longest-prefix matching)。**

- 网络前缀越长，其**地址块就越小，因而路由就越<u>==具体==</u> (more specific) 。**

- 最长前缀匹配又称为**最长匹配**或**最佳匹配**。


##### 最长前缀匹配举例

![image-20220319205849004](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205849.png/)

![image-20220319205857189](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205857.png/)

![image-20220319205902781](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319205903.png/)



#### \3. 使用二叉线索查找路由表

- 当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题。 
- **为了进行更加有效的查找**，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后**自上而下地按层次**进行查找。这里最常用的就是**二叉线索** (binary trie)。
- 为了简化二叉线索的结构,可以使用**唯一前缀**来构造二叉线索
- IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。
- 为了提高二叉线索的查找速度，广泛使用了各种**压缩**技术。 

##### 用 5 个前缀构成的二叉线索

![image-20220319210032913](https://gitee.com/yonaspigeon/giteepicstore/raw/master/master/20220319210033.png/)

##### 在二叉线索查找IP地址

<img src="https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411140658.png" alt="image-20220411140658603" style="zoom:67%;" />

## 4.4 网际控制报文协议 ICMP

为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。
ICMP 是互联网的标准协议。
ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。
但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。 

#### ICMP 报文的格式 

![image-20220411141233375](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411141233.png)

### 4.4.1 ICMP 报文的种类

- ICMP 报文的种类有两种，即 ICMP **差错报告报文**和 ICMP **询问报文**。 

- ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即**类型、代码和检验和**。接着的 4 个字节的内容与 ICMP 的类型有关。

![image-20220411141348477](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411141348.png)

#### ICMP 差错报告报文共有 4 种

- 终点不可达 

- 时间超过 

- 参数问题 

- 改变路由（重定向）(Redirect) 


#### ICMP 差错报告报文的数据字段的内容

![image-20220411141442806](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411141443.png)

#### ICMP 询问报文有两种

- 回送请求和回答报文
- 时间戳请求和回答报文

![image-20220411142634026](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411142634.png)

下面的几种 ICMP 报文不再使用：

- 信息请求与回答报文
- 掩码地址请求和回答报文
- 路由器询问和通告报文 
- 源点抑制报文

#### <u>不应</u>发送 ICMP 差错报告报文的几种情况

- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
- 对具有多播地址的数据报都不发送 ICMP 差错报告报文。
- 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

### 4.4.2 ICMP 的应用举例

**PING** (Packet InterNet Groper) 

- PING 用来测试两个主机之间的**连通性**。

- PING 使用了 **ICMP 回送请求与回送回答报文**。

- PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。


#### PING 的应用举例

### ![image-20220411142806740](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411142807.png)4.4.2 ICMP 的应用举例

Traceroute 的应用举例

- 在 Windows 操作系统中这个命令是 tracert。

- **用来跟踪一个分组从源点到终点的路径**。
- 它利用 IP 数据报中的 **TTL 字段和 ICMP 时间超过差错报告报文和ICMP中鼎啊不可达差错报告报文**实现对从源点到终点的路径的跟踪。

![image-20220411142946943](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411142947.png)

## 4.5 IPV6

- IP 是互联网的核心协议。
- 面临问题:
  - 互联网经过几十年的飞速发展，到 2011 年 2 月，IPv4 的 32 位地址已经耗尽。
  - ISP 已经不能再申请到新的 IP 地址块了。
  - 我国在 2014 – 2015 年也逐步停止了向新用户和应用分配 IPv4 地址。
- 解决 IP 地址耗尽的根本措施就是采用具有更大地址空间的新版本的 IP，即 IPv6。

### 4.5.1  IPv6 的基本首部

- IPv6 仍支持无连接的传送
- 将协议数据单元 PDU 称为分组。为方便起见，本书仍采用数据报这一名词。

所引进的主要变化如下：

1. **更大的地址空间**。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。 

2. **扩展的地址层次结构**。 

3. **灵活的首部格式**。 IPv6 定义了许多可选的扩展首部。

4. **改进的选项**。 IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。

5. **允许协议继续扩充**。

6. **支持即插即用**（即自动配置）。因此 IPv6 不需要使用 DHCP。

7. **支持资源的预分配**。 IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。

8. **IPv6 首部改为 8 字节对齐**。首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。

#### IPv6 数据报的一般形式

IPv6 数据报由两大部分组成：

- **基本首部** (base header)
- **有效载荷** (payload)。有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分。

![image-20220411144117829](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411144118.png)

#### IPv6 数据报的基本首部

- IPv6 将首部长度变为**固定的 40 字节**，称为**基本首部**。
- 把首部中不必要的功能取消了，使得 IPv6 首部的字段数减少到只有 8 个。
- lPv6 对首部中的某些字段进行了如下的更改：

![image-20220411144221096](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411144221.png)

![image-20220411144613031](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411144613.png)

- **版本**(version)—— 4 位。它指明了协议的版本，对 IPv6 该字段总是 6。 
- **通信量类**(traffic class)—— 8 位。这是为了区分不同的 IPv6 数据报的类别或优先级。目前正在进行不同的通信量类性能的实验。 
- **流标号**(flow label)—— 20 位。 “流”是互联网络上从特定源点到特定终点的一系列数据报， “流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。 
- **有效载荷长度**(payload length)—— 16 位。它指明 IPv6 数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是 64 KB。 
- **下一个首部**(next header)—— 8 位。它相当于 IPv4 的协议字段或可选字段。 
- **跳数限制**(hop limit)—— 8 位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减 1。当跳数限制的值为零时，就要将此数据报丢弃。 
- **源地址**—— 128 位。是数据报的发送站的 IP 地址。
- **目的地址**—— 128 位。是数据报的接收站的 IP 地址。 

#### IPv6 的扩展首部

- lPv6 把原来 IPv4 首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理。
- 数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部）。
- 这样就大大提高了路由器的处理效率。 

#### 六种扩展首部

1.逐跳选项

2.路由选择

3.分片

4.鉴别

5.封装安全有效载荷

6.目的站选项 

### 4.5.2  IPv6 的地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. **单播** (unicast)：传统的点对点通信。

2. **多播** (multicast)：一点对多点的通信。

3. **任播** (anycast)：这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。

#### 结点与接口

- lPv6 将实现 IPv6 的主机和路由器均称为结点。
- 一个结点就可能有多个与链路相连的接口。
- lPv6 地址是分配给结点上面的接口的。
  1. 一个接口可以有多个单播地址。
  2. 其中的任何一个地址都可以当作到达该结点的目的地址。即一个结点接口的单播地址可用来唯一地标志该结点。

#### 冒号十六进制记法

![image-20220411145407580](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411145407.png)

#### 零压缩

![image-20220411145816358](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411145816.png)

#### 点分十进制记法的后缀

![image-20220411150447984](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220411150543.png)

## 4.6互连网的路由选择协议

### 4.6.1路由选择协议

#### 1. 理想的路由算法

- 算法必须是**正确的和完整**的。 
- 算法在计算上应**简单**。 
- 算法应能适应通信量和网络拓扑的变化，这就是说，要有**自适应**性。 
- 算法应具有**稳定性**。 
- 算法应是**公平**的。 
- 算法应是**最佳**的。 

##### 关于“最佳路由”

- 不存在一种绝对的最佳路由算法。
- 所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。
- 实际的路由选择算法，应尽可能接近于理想的算法。 

##### 路由选择是个非常复杂的问题

1. 它是网络中的所有结点共同协调工作的结果。
2. 路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。
3. 网络拥塞时，很难获得所需要的路由选择信息 

#### 从路由算法的自适应性考虑

- **静态路由选择策略**——即非自适应路由选择
  - <u>简单和开销较小</u>，
  - <u>但不能及时适应网络状态的变化。</u> 
- **动态路由选择策略**——即自适应路由选择
  - <u>较好地适应网络状态的变化</u>，但实现起来
  - <u>较为复杂，开销也比较大</u>。 

### 2.  分层次的路由选择协议

![image-20220413134540890](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413134602.png)

互联网采用分层次的路由选择协议。这是因为：

1. 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。
2. 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。 

#### 自治系统 AS (Autonomous System) 

- **自治系统 AS 的定义**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。
- 现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但重**要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略**。

![image-20220413135011063](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413135011.png)

#### 互联网有两大类路由选择协议

- ##### 内部网关协议 IGP (Interior Gateway Protocol)  

  - 在一个自治系统内部使用的路由选择协议。
  - 目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

- ##### 外部网关协议 EGP (External Gateway Protocol) 

  - 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。
  - 在外部网关协议中目前使用最多的是 BGP-4。 

![image-20220413135225260](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413135225.png)

### 4.6.2  内部网关协议 RIP

![image-20220413135617256](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413135617.png)

#### 1.RIP工作原理

![image-20220413135526798](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413135527.png)

> #### “距离”的定义
>
> - 从一个路由器到**直接连接**的网络的距离定义为 1。
> - 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。
> - RIP 协议中的“距离”也称为“**跳数**”(hop count)，因为每经过一个路由器，跳数就加 1。
> - 这里的“距离”实际上指的是“**最短距离**”。 
>
> - RIP 认为一个**好的路由**就是它通过的路由器的数目少，即“**距离短**”。
> - RIP 允许一条路径最多只能包含 **15 个路由器**。
> - “距离”的最大值为 **16** 时即相当于**不可达**。可见 RIP 只适用于小型互联网。
> - **RIP 不能在两个网络之间同时使用多条路由**。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。 
>
> ![image-20220413135922309](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413135922.png)

##### RIP 协议的三个特点

- 仅和**相邻**路由器交换信息。 
- 交换的信息是当前本路由器所知道的**全部**信息，即自己的路由表。
-  按**固定的时间间隔**交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

##### 路由表的建立

- 路由器在**刚刚开始工作**时，只知道到直接连接的网络的距离（此距离定义为 1）。**它的路由表是空的。**
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并**更新路由信息**。
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
- RIP 协议的**收敛** (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。 

##### 路由表的主要信息

![image-20220413141218982](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413141219.png)

#### **2.距离向量算法(考点)**

![image-20220413141419235](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413141419.png)

- 距离向量算法的基础就是 Bellman-Ford 算法（或 Ford-Fulkerson 算法）。

- 这种算法的要点是这样的：

- > 设X是结点 A 到 B 的最短路径上的一个结点。
  > 若把路径 A→B 拆成两段路径 A→X 和 X→B，则每一段路径 A→X 和 X→B 也都分别是结点 A 到 X 和结点 X 到 B 的最短路径。

![image-20220413143455863](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413143456.png)

![image-20220413143534611](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413143534.png)

#### 3. RIP2 协议的报文格式 

![image-20220413143931859](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413143932.png)

- RIP2 报文由**首部**和**路由**部分组成。
- RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。地址族标识符（又称为地址类别）字段用来标志所使用的地址协议。
- 路由标记填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。
- 再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。 

- 一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送。
- RIP2 **具有简单的鉴别功能**。
- 若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。
- 在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。

##### 好消息传播得快，坏消息传播得慢

- **RIP 协议特点**：好消息传播得快，坏消息传播得慢。
- **RIP 存在的一个问题**：当网络出现故障时，要经过**比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器**。

![image-20220413144629239](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144629.png)

![image-20220413144802281](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144802.png)

![image-20220413144809758](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144809.png)

![image-20220413144821770](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144821.png)

![image-20220413144830059](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144830.png)

![image-20220413144837469](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413144837.png)

#### RIP 协议的优缺点

- **优点**：
  - 实现简单，开销较小。
- **缺点**：
  - **RIP 限制了网络的规模**，它能使用的**最大距离为 15**（16 表示不可达）。
  - 路由器之间交换的路由信息是路由器中的完整路由表，因而**随着网络规模的扩大，开销也就增加。** 
  - “**坏消息传播得慢**”，使更新过程的收敛时间过长。

### 4.5.3  内部网关协议 OSPF

开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。
OSPF 的原理很简单，但实现起来却较复杂。

#### 1.  OSPF 协议的基本特点

- “**开放**”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。
- “**最短路径优先**”是因为使用了 Dijkstra 提出的最短路径算法 SPF
- 采用**分布式的链路状态协议** (link state protocol)。 
- 注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

##### 三个要点

- **向本自治系统中所有路由器发送信息**，这里使用的方法是**洪泛法**。
- 发送的信息就是与本路由器**相邻**的所有路由器的链路状态，但这只是路由器所知道的部分信息。
  - **“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。** 
- 只有当链路状态**发生变化**时，路由器才用洪泛法向所有路由器发送此信息。 

##### 链路状态数据库 (link-state database) 

- 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。
- 这个数据库实际上就是**全网的拓扑结构图，它在全网范围内是一致的**（这称为链路状态数据库的同步）。
- OSPF 的链路状态数据库**能较快地进行更新**，使各个路由器能及时更新其路由表。
- **OSPF 的更新过程收敛得快是其重要优点。**

##### OSPF 划分为两种不同的区域

为了降低资源消耗

![image-20220413150004376](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220413150004.png)

###### 划分区域

- **好处**
  - 减少了网络上的通信量
  - 减少了需要维护的状态数量
- **缺点**
  - 交换的信息种类增多了
  - 是OSPF协议变得复杂

##### OSPF 的其他特点

- OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，OSPF 对于不同类型的业务可**计算出不同的路由**。
- 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的**负载平衡**。
- 所有在 OSPF 路由器之间交换的分组都具有**鉴别**的功能。
- 支持**可变长度的子网划分和无分类编址 CIDR。**
- 每一个链路状态都带上一个 **32 位的序号**，序号越大状态就越新。

### 4.6.4  外部网关协议 BGP

- BGP 是不同自治系统的路由器之间交换路由信息的协议。 
- BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278。 
- 可以将 BGP-4 简写为 BGP。 

#### 1.BGP特点

- 用于自治系统AS之间的路由选择
- 互联网的规模太大，使得自治系统之间路由选择**非常困难**。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
  1. 当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。
  2. 比较合理的做法是在 AS 之间交换“可达性”信息。

- 自治系统之间的路由选择**必须考虑有关策略**。
- 网关协议 BGP 只能是力求寻找一条**能够到达目的网络且比较好的路由**（不能兜圈子），而**并非要寻找一条最佳路由**。 
- 采用了 **路径向量** 路由选择协议

##### BGP 发言人

- l每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (BGP speaker) 。
- l一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。 

![image-20220418133835051](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418133835.png)

#### 2.EBGP和IBGP

![image-20220418134103009](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418134103.png)

![image-20220418134351447](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418134351.png)

![image-20220418134557325](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418134557.png)

##### IGP、IBGP和EBGP关系

![image-20220418134326504](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418134326.png)

##### BGP路由信息

![image-20220418134846542](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418134846.png)

![image-20220418135841794](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418135842.png)

#### 3.三种不同的自治系统AS

![image-20220418140034104](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418140034.png)

##### BGP避免兜圈子

![image-20220418140749136](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418140749.png)

#### 4.BGP路由的选择

![image-20220418140821099](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418140821.png)

##### 4.1本地偏好值最高

![image-20220418141007340](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418141007.png)

##### 4.2AS跳数最小

![image-20220418141319837](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418141320.png)

##### 4.3热土豆路由选择算法

![image-20220418141553461](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418141554.png)

##### 4.4BGP ID比较

**以上方法都不行时**

选最小的ID

#### 5.BGP-4四种报文

![image-20220418142601375](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418142602.png)

##### BGP报文具有通用首部

![image-20220418142820035](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418142820.png)

### 4.6.5路由器的构成

![image-20220418143020586](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418143021.png)

#### 1. 路由器的结构

![image-20220418143831595](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418143832.png)

##### 转发 和 路由选择 区别

![image-20220418144232992](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418144233.png)

##### 输入端口对线路上收到的分组的处理

![image-20220418144735858](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418144736.png)

##### 输出端口将交换结构传来的分组发送到线路

![image-20220418144805277](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418144805.png)

#### 2.交换结构

![image-20220418144934434](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418144934.png)

##### 1.通过存储器

![image-20220418145004086](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145004.png)

##### 2.通过总线

![image-20220418145312695](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145313.png)

##### 3.通过纵横交换结构

![image-20220418145416036](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145416.png)

## 4.7IP多播

### 4.7.1 IP多播的基本概念

![image-20220418145747713](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145747.png)

![image-20220418150130754](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418150131.png)

#### 多播可大大节约网络资源

![image-20220418145829258](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145829.png)

![image-20220418145937676](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418145938.png)

#### 多播IP地址

![image-20220418150316854](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418150317.png)

#### 多播数据报

![image-20220418150429159](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220418150429.png)

### 4.7.2局域网上进行多播

![image-20220420133300431](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420133301.png)

#### D类IP地址与以太网多播地址映射关系

![image-20220420133534011](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420133534.png)

### 4.7.3<u>网络组管理协议IGMP</u>和<u>多播路由选择协议</u>

#### 1.  IP 多播需要两种协议

为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。
连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议。 

##### IGMP使得多播路由器知道多播组成员信息

![image-20220420133920070](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420133920.png)

##### 多播路由选择协议更为复杂

![image-20220420134125908](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420134126.png)

- 多播转发必须**动态地适应多播组成员的变化**（这时网络拓扑并未发生变化）。请注意，单播路由选择通常是在网络拓扑发生变化时才需要更新路由。
- 多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的**目的地址**，而是还要考虑这个多播数据报**从什么地方来和要到什么地方去**。 
- 多播数据报**可以由没有加入多播组的主机发出**，也可以通过没有组成员接入的网络。 

#### 2.  网际组管理协议 IGMP

- 和 ICMP 相似，**IGMP** **使用** **IP** **数据报传递其报文**（即 IGMP 报文加上 IP 首部构成 IP 数据报）
- 但它也向 IP 提供服务。
- 因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分。 

##### IGMP 工作可分为两个阶段

**第一阶段：加入多播组。**

1. 当某个主机加入新的多播组时，该主机应向多播组的多播地址发送 IGMP 报文，声明自己要成为该组的成员。

2. 本地的多播路由器收到 IGMP 报文后，将组成员关系转发给互联网上的其他多播路由器。

![image-20220420135327071](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420135327.png)

**第二阶段：探询组成员变化情况。**

1. 因为组成员关系是动态的，因此本地多播路由器要**周期性**地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。

2. **只要**对某个组有**一个主机响应**，那么多播路由器就认为这个组是活跃的。

3. 但一个组在经过几次的探询后仍然没有一个主机响应，则不再将该组的成员关系转发给其他的多播路由器。

![image-20220420135637001](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420135637.png)

##### IGMP 采用的一些具体措施（避免大量开销）

- **在主机和多播路由器之间的所有通信都是使用** **IP** **多播。**
- 多播路由器在探询组成员关系时，**对所有组只发送一个请求信息**。
- 当同一个网络上连接有几个多播路由器时，它们能够迅速和有效地选择**其中的一个**来探询主机的成员关系。 
- **分散响应**
- **抑制机制**

![image-20220420135829825](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420135830.png)

#### 3.多播路由选择

![image-20220420140501205](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420140501.png)

**多播路由选择协议在转发多播数据报时使用三种方法：**

1. 洪泛与剪除
2. 隧道技术 (tunneling)
3. 基于核心的发现技术

##### (1) 洪泛与剪除

- 这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的。

- 一开始，路由器转发多播数据报使用**洪泛**的方法（这就是广播）。

- 为了避免兜圈子，采用了叫做**反向路径广播** **RPB** (Reverse Path Broadcasting) 的策略。RPB要点：

  - **检查转发**

  - ![image-20220420141027830](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420141028.png)

  - **以源为根节点**

  - ![image-20220420141113345](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420141113.png)

  - **剪枝与嫁接**

  - ![image-20220420141308776](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420141309.png)

  - **例子**

  - > ![image-20220420141950650](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420141950.png) 

##### (2) 隧道技术 (tunneling) 

![image-20220420142350139](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420142350.png)

##### (3) 基于核心的发现技术 

- 这种方法对于多播组的大小在较大范围内变化时都适合。
- 这种方法是对每一个多播组 G 指定一个**核心**(core) 路由器，给出它的 **IP** **单播地址**。
- 核心路由器按照前面讲过的方法创建出对应于**多播组** **G** **的转发树**。 
- 几种协议
  - 距离向量多播路由选择协议 **DVMRP** (Distance Vector Multicast Routing Protocol)
  - 基于核心的转发树 **CBT** (Core Based Tree) 
  - 开放最短通路优先的多播扩展 **MOSPF** (Multicast Extensions to OSPF) 
  - 协议无关多播-稀疏方式 **PIM-SM** (Protocol Independent Multicast-Sparse Mode) 
  - 协议无关多播-密集方式 **PIM-DM** (Protocol Independent Multicast-Dense Mode) 

## 4.8虚拟专用网 VPN和网络地址转换 NAT

### 4.8.1  虚拟专用网 VPN

- 由于 **IP 地址的紧缺**，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。
- 考虑到**互联网并不很安全**，一个机构内也并不需要把所有的主机接入到外部的互联网。
- 假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在**机构内部使用**的计算机就可以由本机构**自行分配其 IP 地址**。

#### 本地地址与全球地址

- **本地地址**——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。
- **全球地址**——全球唯一的 IP 地址，必须向互联网的管理机构申请。 
- **问题**：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。
- **解决**：<u>专用地址为目的地址的数据报不转发</u>

#### RFC 1918 指明的专用 IP 地址

![image-20220420143749375](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420143749.png)

#### 专用网

- 采用这样的专用 IP 地址的互连网络称为**专用互联网**或**本地互联网**，或更简单些，就叫做**专用网**。
- 因为这些专用地址仅在本机构内部使用。专用IP地址也叫做**可重用地址** (reusable address)。

#### 虚拟专用网 VPN

- 利用**公用的互联网**作为本机构各专用网之间的**通信载体**，这样的专用网又称为**虚拟专用网VPN** (Virtual Private Network)。
- “**专用网**”是因为这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。
- “**虚拟**”表示“好像是”，但实际上并不是，因为现在并**没有真正使用通信专线**，而VPN只是在效果上和真正的专用网一样。

#### 虚拟专用网 VPN 构建

- 如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的**数据都必须加密**。
- 一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。
####用隧道技术实现虚拟专用网

![image-20220420144556783](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420144557.png)

![image-20220420144658370](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420144658.png)

#### VPN类型

![image-20220420144951001](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420144951.png)

### 4.8.2网络地址转换NAT

**问题**：在专用网上使用专用地址的主机如何与互联网上的主机通信（并不需要加密）？

**解决**：

1. 再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。

2. 采用网络地址转换 NAT。这是目前使用得最多的方法。

#### 网络地址转换 NAT

- 网络地址转换 NAT (Network Address Translation) 方法于1994年提出。
- 需要在专用网连接到互联网的路由器上安装 NAT 软件。装有 NAT 软件的路由器叫做 **NAT路由器，它至少有一个有效的外部全球IP地址**。
- 所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器**上将其本地地址转换成全球 IP 地址**，才能和互联网连接。 

#### 网络地址转换的过程

![image-20220420145732625](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420145733.png)

可以看出，在内部主机与外部主机通信时，在NAT路由器上发生了两次地址转换：

1. **离开**专用网时：替换源地址，将内部地址替换为全球地址；

2. **进入**专用网时：替换目的地址，将全球地址替换为内部地址；

![image-20220420150131264](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420150131.png)

#### 网络地址转换 NAT

- 当 NAT 路由器具有 *n* 个全球 IP 地址时，专用网内**最多可以同时有** **n** **台主机接入到互联网**。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。
- 通过 NAT 路由器的通信必须由专用网内的主机发起。**专用网内部的主机不能充当服务器用**，因为互联网上的客户无法请求专用网内的服务器提供服务。

#### 网络地址与端口号转换 NAPT

![image-20220420150402037](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420150402.png)

#### NAPT地址转换表

![image-20220420150502925](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220420150503.png)

## 4.10软件定义网络

### 4.10.1SDN与协议OpenFlow

![image-20220425133631617](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425133632.png)

![image-20220425134335909](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425134336.png)

![image-20220425134629811](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425134630.png)

![image-20220425134842295](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425134842.png)

![image-20220425134936807](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425134937.png)

![image-20220425135311539](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425135311.png)

![image-20220425135352092](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425135352.png)

![image-20220425135447072](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425135447.png)

简单转发

![image-20220425135925734](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425135926.png)

负载均衡

![image-20220425140213568](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425140214.png)

防火墙

![image-20220425140440102](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425140440.png)

### 4.10.2 SDN体系结构

![image-20220425140540376](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425140541.png)

![image-20220425141001382](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425141001.png)

![image-20220425141203392](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425141203.png)

### 4.10.3 SDN控制器

![image-20220425141328801](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220425141329.png)

# 5.传输层

![image-20220427133234935](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427133235.png)

## 5.1运输层协议概述

### 5.1.1   进程之间的通信

![image-20220427133651058](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427133651.png)

#### 运输层的作用

![image-20220427134505782](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427134506.png)

#### 屏蔽作用

![image-20220427134516457](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427134516.png)

#### 可靠信道和不可靠信道

![image-20220427134917728](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427134918.png)

### 5.1.2运输层的两个主要协议

![image-20220427134933888](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427134934.png)

#### 运输协议数据单元

![image-20220427135016113](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427135016.png)

#### UDP和TCP区别

![image-20220427135754356](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427135754.png)

### 5.1.3运输层的端口

![image-20220427140234719](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427140235.png)

#### 需要考虑的问题

![image-20220427140404955](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427140405.png)

#### 端口号

![image-20220427140912415](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427140912.png)

#### 软件端口与硬件端口

![image-20220427141026717](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427141027.png)

#### TCP/IP运输层端口的标志

![image-20220427141559327](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427141559.png)

#### 两大类 三种类型的接口

![image-20220427142131065](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427142131.png)

大多数网站默认端口 80

> www.baidu.com:80

#### 常用端口号

![image-20220427142620433](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427142621.png)

**UDP的80和TCP的80不一样**

## 5.2用户数据报协议UDP

### 5.2.1UDP概述

![image-20220427142924246](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427142924.png)

#### UDP主要特点

![image-20220427143025480](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427143025.png)

#### UDP是面向报文的

![image-20220427143629701](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427143630.png)

![image-20220427143646233](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427143646.png)

#### UDP通信和端口号的关系

![image-20220427143825471](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427143825.png)

### 5.2.2UDP首部格式

![image-20220427144353117](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427144353.png)

#### UDP基于端口的分用

![image-20220427144500592](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427144501.png)

![image-20220427144755019](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427144755.png)

#### 计算UDP校验和的例子

![image-20220427144912876](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427144913.png)

## 5.3传输控制协议TCP

### 5.3.1 TCP主要特点

![image-20220427145443457](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427145443.png)

![image-20220427150100195](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427150100.png)

#### TCP面向流的概念

![image-20220427150133029](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427150133.png)

![image-20220427150314139](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427150314.png)

![image-20220427150535330](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220427150535.png)

### 5.3.2 TCP的连接

![image-20220502133049346](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502133228.png)

#### 套接字(四元组)

IP地址和端口号的绑定

![image-20220502133953173](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502133954.png)

五元组{IP1,P1,IP2,P2,TCP},唯一表示在互联网中连接

![image-20220502133919096](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502133919.png)

#### Socket有不同意思

![image-20220502134107324](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502134107.png)

## 5.4可靠传输的工作原理

### 5.4.1停止等待协议

![image-20220502134415211](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502134415.png)

#### 理想传输条件的特点

![image-20220502134451035](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502134451.png)

#### 停止等待协议

![image-20220502134911782](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502134912.png)

##### 1.无差错情况

![image-20220502135158218](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502135158.png)

##### 2.出现差错

![image-20220502135254701](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502135255.png)

![image-20220502135355641](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502135356.png)

![image-20220502135629972](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502135630.png)

##### 3.确认丢失和确认迟到

![image-20220502135744824](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502135745.png)

![image-20220502140025549](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502140025.png)

##### 4.信道利用率

![image-20220502140531836](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502140532.png)

![image-20220502140756769](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502140757.png)



### 5.4.2连续ARQ协议

#### 提高效率

流水线传输

![image-20220502141029675](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502141030.png)

#### ARQ协议

![image-20220502141352382](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502141353.png)

#### 发送窗口

![image-20220502142212683](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502142213.png)

#### 累积确认

![image-20220502142336079](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502142336.png)

![image-20220502142452735](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502142453.png)

![image-20220502142720537](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502142720.png)

**错误处往后全部重传**

![image-20220502142858527](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502142859.png)

## 5.5 TCP报文段的首部格式

![image-20220502143016898](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502143017.png)

![image-20220502143344712](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502143345.png)

![image-20220502143505419](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502143506.png)

![image-20220502143630671](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502143631.png)

![image-20220502143947894](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502143948.png)

![image-20220502144348854](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502144349.png)

![image-20220502144639116](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502144639.png)

![image-20220502145417897](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145418.png)

![image-20220502145145779](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145146.png)

> 如cmd的CTRL+C紧急终止

![image-20220502145302355](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145302.png)

![image-20220502145321760](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145322.png)

![image-20220502145423700](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145423.png)

![image-20220502145445392](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145445.png)

![image-20220502145526102](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145526.png)

![image-20220502145554453](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145554.png)

![image-20220502145602751](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145603.png)

![image-20220502145923785](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145924.png)

![image-20220502145935082](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502145935.png)

![image-20220502150101665](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150102.png)

![image-20220502150221235](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150221.png)

![image-20220502150234939](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150235.png)

![image-20220502150247588](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150248.png)

![image-20220502150455650](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150456.png)

![image-20220502150503763](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150504.png)

![image-20220502150544950](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220502150545.png)

### 5.6.1以字节为单位的滑动窗口

![image-20220504133150189](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504133159.png)

#### 发送窗口

![image-20220504133510088](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504133510.png)

![image-20220504134257197](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504134258.png)

#### 窗口的滑动

![image-20220504135439251](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504135440.png)

#### 发送缓存

![image-20220504135955148](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504135955.png)

#### 接收缓存

![image-20220504140125837](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504140126.png)

![image-20220504140349737](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504140350.png)

### 5.6.2超时重传时间的选择

![image-20220504140905330](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504140906.png)

![image-20220504142321395](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504142322.png)

#### 加权平均往返时间RTTS

![image-20220504142331044](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504142331.png)

#### 超时重传时间RTO

![image-20220504142755804](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504142756.png)

#### RTT的测量

![image-20220504143319071](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504143319.png)

#### 解决RTT测量问题

![image-20220504143511441](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504143511.png)

![image-20220504143805674](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504143806.png)

### 5.6.3选择确认SACK

仅发送没收到的字节

![image-20220504144122203](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504144122.png)

#### SACK规定 

![image-20220504144129717](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504144130.png)

![image-20220504144800303](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504144801.png)

### 5.7.1流量控制

![image-20220504144835777](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504144836.png)

![image-20220504145736139](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504145736.png)

![image-20220504150023672](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504150024.png)

![image-20220504150153173](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504150153.png)

### 5.7.2 TCP传输效率

![image-20220504150222572](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220504150223.png)

#### 糊涂窗口综合征

![image-20220509133821805](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509133829.png)

##### 发送方糊涂

![image-20220509134100269](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509134100.png)

##### 接收方糊涂

![image-20220509134732139](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509134732.png)

![image-20220509135101540](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509135101.png)

## 5.8TCP的拥塞控制

### 5.8.1拥塞控制的一般原理

![image-20220509135304957](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509135305.png)

#### 拥塞产生的原因

![image-20220509135853911](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509135854.png)

##### 解决方案

![image-20220509140243102](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509140243.png)

![image-20220509140535639](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509140536.png)

![image-20220509141049364](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509141049.png)

#### 拥塞控制原理

![image-20220509141111404](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509141111.png)

#### 开环控制和闭环控制

![image-20220509141357045](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509141357.png)

#### 闭环策略

![image-20220509142243307](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509142243.png)

![image-20220509142618021](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509142618.png)

![image-20220509143217374](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509143217.png)

### 5.8.2TCP拥塞控制方法

![image-20220509143327644](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509143328.png)

#### 拥塞窗口变化的原则

![image-20220509143809472](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509143809.png)

#### 发送方判断拥塞：隐式反馈

![image-20220509144038630](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509144038.png)

#### 1.慢开始算法

![image-20220509144427738](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509144428.png)

![image-20220509144851667](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509144852.png)

![image-20220509145010858](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509145011.png)

![image-20220509145413872](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509145414.png)

###### 传输轮次

![image-20220509145725688](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509145726.png)

###### 慢开始门限

![image-20220509145808855](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509145809.png)

#### 2.拥塞避免算法

![image-20220509145923254](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509145923.png)

![image-20220509150125621](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509150126.png)

#### 出现拥塞时

![image-20220509150210139](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509150210.png)

![image-20220509150447820](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220509150448.png)

#### 快重传

收到三个ack立即重传

![image-20220511135150396](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511135157.png)

#### 快恢复FR

![image-20220511135232200](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511135232.png)

![image-20220511135520002](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511135520.png)

#### TCP拥塞控制流程图

![image-20220511135620591](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511135620.png)

#### 发送窗口上限

![image-20220511140140310](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511140140.png)

### 5.8.3主动队列管理

![image-20220511140214381](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511140214.png)

#### FIFO先进先出处理规则

![image-20220511140613444](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511140613.png)

![image-20220511141028211](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141028.png)

#### 问题：全局同步

![image-20220511141219324](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141219.png)

![image-20220511141236151](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141236.png)

#### 主动队列管理

![image-20220511141306578](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141306.png)

#### 随即早检测

![image-20220511141442293](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141442.png)

![image-20220511141708974](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220511141709.png)

# 6.应用层

## 6.1域名系统 DNS

### 6.1.1  域名系统概述

- l许多应用层软件经常直接使用域名系统 DNS (Domain Name System)，但计算机的用户只是间接而不是直接使用域名系统。 
- l互联网采用层次结构的命名树作为主机的名字，并使用分布式的域名系统 DNS。
- l名字到 IP 地址的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，运行该程序的机器称为域名服务器。 

#### 域名解析过程要点

![image-20220516135132617](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516135133.png)

### 6.1.2互联网的域名结构

![image-20220516135303012](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516135303.png)

![image-20220516135917536](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516135918.png)

#### 全球顶级域名TLD

![image-20220516140641782](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516140643.png)

#### 互联网的域名空间结构

![image-20220516140902986](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516140904.png)

### 6.1.3域名服务器

![image-20220516141134104](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516141135.png)

#### 区的不同划分方法举例

![image-20220516141420750](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516141421.png)

#### 树状结构

![image-20220516141530366](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516141531.png)

#### 域名服务器类型

![image-20220516141640944](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516141641.png)

##### 1.根域名服务器

![image-20220516142546322](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516142547.png)

###### 13套装置

![image-20220516142826502](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516142827.png)

![image-20220516143023953](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143024.png)

![image-20220516143217284](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143218.png)

##### 2.顶级域名服务器

![image-20220516143345679](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143346.png)

##### 3.权限域名服务器

![image-20220516143433454](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143434.png)

##### 4.本地域名服务器

![image-20220516143453181](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143454.png)

#### 提高域名服务器的可靠性

![image-20220516143638960](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143639.png)

#### 域名解析过程

![image-20220516143837604](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516143838.png)

##### 迭代查询

![image-20220516144003754](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516144004.png)

##### 递归查询

![image-20220516144158189](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516144158.png)

#### 高速缓存

![image-20220516144405544](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516144406.png)

## 6.4万维网

### 6.4.1万维网概述

![image-20220516144942489](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516144943.png)

![image-20220516144950482](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516144951.png)

#### 万维网是分布式超媒体系统

![image-20220516145046002](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516145046.png)

#### 万维网的工作方式

![image-20220516145226913](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516145227.png)

#### 万维网要解决的问题

![image-20220516150226465](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516150227.png)

![image-20220516150333241](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220516150333.png)

### 6.4.2统一资源定位符URL

![image-20220518133201555](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518133202.png)

#### 1.URL格式

![image-20220518133442258](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518133443.png)

![image-20220518133630979](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518133631.png)

#### 2.使用HTTP的URL

![image-20220518134058856](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518134059.png)

### 6.4.3超文本传送协议HTTP

- 面向事务的应用层协议
- 使用TCP连接进行可靠的传送
- 定义了浏览器与万维网服务器通信的格式和规则
- 是万维网上能够可靠交换文件的重要基础

![image-20220518134308394](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518134309.png)

#### 1.HTTP操作过程

![image-20220518135728851](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518135729.png)

![image-20220518135831730](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518135832.png)

##### HTTP特点 

![image-20220518140201655](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518140202.png)

##### 请求一个万维网所需要的时间

![image-20220518140424171](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518140425.png)

##### HTTP1主要缺点

![image-20220518140844287](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518140845.png)

##### 流水线方式：持续连接

![image-20220518141242826](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518141243.png)

#### HTTP2

![image-20220518141452263](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518141453.png)

![image-20220518141755830](https://cdn.jsdelivr.net/gh/stingo1218/pic/img/20220518141757.png)
